<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QuickZ | Teacher Panel</title>
    
    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&family=Outfit:wght@400;500;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js" async></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>

    <style>
        body { font-family: 'Hind Siliguri', sans-serif; background: #f8fafc; }
        .hidden { display: none !important; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #4f46e5; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Dark Mode */
        .dark body { background: #0a0a0a; color: #f0f0f0; }
        .dark .bg-white { background: #111111; }
        .dark .text-slate-800 { color: #f0f0f0; }
        .dark .text-slate-600 { color: #b0b0b0; }
        .dark .text-slate-400 { color: #888888; }
        .dark .text-slate-500 { color: #a0a0a0; }
        .dark .bg-slate-50 { background: #111111; }
        .dark .border { border-color: #333333; }
        .dark .bg-slate-100 { background: #222222; }
        .dark .bg-slate-200 { background: #333333; }
        .dark .bg-slate-800 { background: #0a0a0a; }
        .dark .bg-slate-900 { background: #050505; }
        .dark .text-slate-300 { color: #d0d0d0; }
        .dark .bg-indigo-50 { background: #1a1a2e; }
        .dark .bg-emerald-50 { background: #0a2a1a; }
        .dark .bg-red-50 { background: #2a0a0a; }
        .dark .bg-amber-50 { background: #2a200a; }
        
        /* Folder Tree Styles */
        .folder-tree { transition: all 0.3s ease; }
        .folder-item { transition: all 0.2s ease; }
        .folder-item:hover { background-color: #f8fafc; }
        .folder-children { margin-left: 24px; border-left: 2px dashed #e2e8f0; padding-left: 12px; }
        .folder-icon { color: #f59e0b; }
        .exam-icon { color: #4f46e5; }
        .live-icon { color: #ef4444; animation: pulse-red 2s infinite; }
        .mock-icon { color: #10b981; }
        
        /* Manual question styles */
        .question-box { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 10px; padding: 15px; margin-bottom: 20px; }
        .option-input { margin-bottom: 8px; }
        .question-list-item { background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; margin-bottom: 10px; }
        .question-list-item .question-text { font-weight: bold; margin-bottom: 8px; }
        .question-list-item .options { font-size: 14px; color: #555; margin-bottom: 8px; }
        .question-list-item .correct-answer { color: #10b981; font-weight: bold; }
        
        /* Three Dot Menu */
        .three-dot-menu { position: relative; }
        .three-dot-btn { padding: 4px 8px; border-radius: 4px; cursor: pointer; transition: all 0.2s; background: transparent; border: none; }
        .three-dot-btn:hover { background: #f1f5f9; }
        .dark .three-dot-btn:hover { background: #333333; }
        .dot-menu-dropdown { 
            position: absolute; 
            top: 100%; 
            right: 0; 
            background: white; 
            border: 1px solid #e2e8f0; 
            border-radius: 8px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.1); 
            z-index: 1000; 
            min-width: 160px;
            display: none;
        }
        .dot-menu-dropdown.show { display: block; }
        .menu-item { 
            padding: 10px 16px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            font-size: 14px;
            transition: all 0.2s;
        }
        .menu-item:hover { background: #f8fafc; }
        .menu-item.edit { color: #3b82f6; }
        .menu-item.rename { color: #8b5cf6; }
        .menu-item.delete { color: #ef4444; }
        .menu-item.add-chapter { color: #10b981; }
        .menu-item.add-exam { color: #f59e0b; }
        .menu-item.view { color: #6366f1; }
        .menu-item.stop { color: #ef4444; }
        .menu-item.take-exam { color: #10b981; }
        
        /* Auto resize textarea */
        textarea {
            resize: vertical;
            min-height: 80px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .auto-resize {
            transition: height 0.2s;
        }
        
        /* Login Animation */
        .login-btn {
            position: relative;
            overflow: hidden;
        }
        
        .login-btn .btn-text {
            display: inline-block;
            transition: transform 0.3s;
        }
        
        .login-btn.loading .btn-text {
            transform: translateY(30px);
        }
        
        .login-btn .loader-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            transition: transform 0.3s;
        }
        
        .login-btn.loading .loader-container {
            transform: translate(-50%, -50%) scale(1);
        }
        
        /* Dropdown fixes */
        .select-container {
            position: relative;
            max-width: 100%;
        }
        
        .select-container select {
            width: 100%;
            padding-right: 40px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* Fix for textarea overflow */
        .question-textarea, .explanation-textarea, .option-textarea {
            resize: vertical;
            min-height: 80px;
            max-height: 300px;
            overflow-y: auto !important;
            word-wrap: break-word;
            white-space: pre-wrap;
        }
        
        /* Math Editor Styles */
        .question-field-container {
            position: relative;
            margin-bottom: 15px;
        }
        
        .math-preview-btn {
            position: absolute;
            right: 5px;
            top: 5px;
            background: transparent;
            color: #666;
            border: none;
            padding: 2px 6px;
            cursor: pointer;
            font-size: 12px;
            z-index: 10;
            opacity: 0.6;
        }
        
        .math-preview-btn:hover {
            opacity: 1;
        }
        
        .question-textarea.math-mode {
            border-color: #4f46e5;
            background: #f8fafc;
            color: transparent;
        }
        
        .math-render-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            padding: 12px;
            overflow: auto;
            background: white;
            border-radius: 8px;
        }
        
        .dark .math-render-overlay {
            background: #111111;
        }
        
        /* Floating Math Button */
        .floating-math-btn {
            position: fixed;
            top: 80px;
            right: 20px;
            background: #4f46e5;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.3s;
        }
        
        .floating-math-btn:hover {
            background: #4338ca;
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(79, 70, 229, 0.4);
        }
        
        .math-symbols-panel {
            position: fixed;
            top: 140px;
            right: 20px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            padding: 15px;
            z-index: 1000;
            width: 320px;
            max-height: 400px;
            overflow-y: auto;
            display: none;
        }
        
        .math-symbols-panel.show {
            display: block;
        }
        
        .symbol-group {
            margin-bottom: 15px;
        }
        
        .symbol-group-title {
            font-size: 12px;
            font-weight: bold;
            color: #64748b;
            margin-bottom: 8px;
            padding-bottom: 4px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .symbol-buttons {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 6px;
        }
        
        .symbol-btn {
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 6px;
            cursor: pointer;
            font-size: 13px;
            text-align: center;
            transition: all 0.2s;
            min-height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .symbol-btn:hover {
            background: #e2e8f0;
            transform: translateY(-2px);
        }
        
        .symbol-btn:active {
            transform: translateY(0);
        }
        
        /* Close button for math panel */
        .math-panel-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: transparent;
            border: none;
            color: #64748b;
            cursor: pointer;
            font-size: 16px;
        }
        
        .math-panel-close:hover {
            color: #ef4444;
        }
        
        /* JSON format buttons */
        .json-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        /* Auto publish checkbox */
        .auto-publish-container {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #f1f5f9;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .dark .auto-publish-container {
            background: #222222;
        }
        
        /* Chapter Children */
        .chapter-children {
            margin-left: 30px;
            border-left: 2px dashed #e2e8f0;
            padding-left: 15px;
            transition: all 0.3s ease;
        }
        
        .dark .chapter-children {
            border-left-color: #333333;
        }
        
        /* Hamburger Menu Styles */
        .hamburger-menu {
            position: relative;
        }
        
        .hamburger-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 24px;
            color: #64748b;
            padding: 8px;
        }
        
        .hamburger-btn:hover {
            color: #4f46e5;
        }
        
        .hamburger-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            z-index: 1000;
            min-width: 180px;
            display: none;
        }
        
        .hamburger-dropdown.show {
            display: block;
        }
        
        .hamburger-item {
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            transition: all 0.2s;
            border-bottom: 1px solid #f1f5f9;
        }
        
        .hamburger-item:last-child {
            border-bottom: none;
        }
        
        .hamburger-item:hover {
            background: #f8fafc;
        }
        
        .hamburger-item.dark-mode {
            color: #f59e0b;
        }
        
        .hamburger-item.settings {
            color: #64748b;
        }
        
        .hamburger-item.logout {
            color: #ef4444;
        }
        
        .dark .hamburger-dropdown {
            background: #111111;
            border-color: #333333;
        }
        
        .dark .hamburger-item {
            border-bottom-color: #333333;
        }
        
        .dark .hamburger-item:hover {
            background: #222222;
        }
        
        /* Result card layout for admin */
        .result-stat-card {
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .result-stat-number {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .result-stat-label {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Compact Result Summary Card */
        .compact-summary-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            border: 1px solid #e2e8f0;
        }

        .dark .compact-summary-card {
            background: #111111;
            border-color: #333333;
        }

        .compact-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e2e8f0;
        }

        .dark .compact-header {
            border-bottom-color: #333333;
        }

        .compact-title {
            font-size: 14px;
            font-weight: bold;
            color: #1e293b;
        }

        .dark .compact-title {
            color: white;
        }

        .compact-date {
            font-size: 11px;
            color: #64748b;
            margin-top: 2px;
        }

        .compact-score-section {
            text-align: right;
        }

        .compact-score {
            font-size: 24px;
            font-weight: 800;
            color: #4f46e5;
            line-height: 1;
        }

        .dark .compact-score {
            color: #818cf8;
        }

        .compact-accuracy {
            font-size: 12px;
            font-weight: 600;
            color: #10b981;
            margin-top: 2px;
        }

        .compact-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .compact-stat-item {
            background: #f8fafc;
            border-radius: 8px;
            padding: 8px;
            text-align: center;
        }

        .dark .compact-stat-item {
            background: #1e293b;
        }

        .compact-stat-value {
            font-size: 14px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 2px;
        }

        .dark .compact-stat-value {
            color: white;
        }

        .compact-stat-label {
            font-size: 9px;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Folder toggle button */
        .folder-toggle-btn {
            transition: transform 0.3s ease;
        }
        
        .folder-toggle-btn.rotated {
            transform: rotate(180deg);
        }
        
        /* Folder item hover effects */
        .folder-item:hover {
            background-color: #f8fafc;
        }
        
        .dark .folder-item:hover {
            background-color: #222222;
        }
        
        /* Group Grid Styles */
        .group-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }
        
        .group-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
        }
        
        .group-card:hover {
            border-color: #4f46e5;
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .dark .group-card {
            background: #111111;
            border-color: #333333;
        }
        
        .group-code {
            font-family: monospace;
            background: #f1f5f9;
            padding: 5px 10px;
            border-radius: 6px;
            font-weight: bold;
            color: #4f46e5;
            margin-top: 5px;
        }
        
        .dark .group-code {
            background: #222222;
            color: #818cf8;
        }
        
        /* Teacher Profile Styles */
        .teacher-profile-form {
            background: white;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #e2e8f0;
        }
        
        .dark .teacher-profile-form {
            background: #111111;
            border-color: #333333;
        }
        
        .teacher-code-badge {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            padding: 10px 15px;
            border-radius: 10px;
            font-family: monospace;
            font-weight: bold;
            text-align: center;
            letter-spacing: 1px;
            margin-top: 10px;
        }
        
        /* Math Panel Fix for Mobile Keyboard */
        .math-symbols-panel.fixed-position {
            position: fixed;
            top: 20px !important;
            right: 20px !important;
            z-index: 9999;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .dark .math-symbols-panel {
            background: #111111;
            border-color: #333333;
        }
        
        .dark .symbol-btn {
            background: #222222;
            border-color: #333333;
            color: #e2e8f0;
        }
        
        .dark .symbol-btn:hover {
            background: #333333;
        }
        
        .dark .symbol-group-title {
            color: #888888;
            border-bottom-color: #333333;
        }
        
        /* Math render in user panel */
        .math-render {
            font-size: 16px;
            line-height: 1.5;
        }
        
        .dark .math-render {
            color: #f0f0f0;
        }
        
        .math-render mjx-container {
            color: inherit !important;
        }
        
        /* Group Switcher */
        .group-switcher {
            position: relative;
        }
        
        .group-switcher-btn {
            background: #4f46e5;
            color: white;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .group-switcher-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            z-index: 1000;
            min-width: 200px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }
        
        .group-switcher-dropdown.show {
            display: block;
        }
        
        .group-switcher-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f1f5f9;
            transition: all 0.2s;
        }
        
        .group-switcher-item:hover {
            background: #f8fafc;
        }
        
        .group-switcher-item.active {
            background: #4f46e5;
            color: white;
        }
        
        .dark .group-switcher-dropdown {
            background: #111111;
            border-color: #333333;
        }
        
        .dark .group-switcher-item {
            border-bottom-color: #333333;
        }
        
        .dark .group-switcher-item:hover {
            background: #222222;
        }
        
        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: #4f46e5;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        /* Student List Styles */
        .student-list-container {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .student-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .student-item:hover {
            background: #f8fafc;
        }
        
        .dark .student-item {
            border-bottom-color: #333333;
        }
        
        .dark .student-item:hover {
            background: #222222;
        }
        
        .student-status {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 600;
        }
        
        .status-active {
            background: #10b981;
            color: white;
        }
        
        .status-disabled {
            background: #ef4444;
            color: white;
        }
        
        .status-blocked {
            background: #f59e0b;
            color: white;
        }
        
        .status-pending {
            background: #64748b;
            color: white;
        }
        
        /* Filter Tabs */
        .filter-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .filter-tab {
            padding: 6px 12px;
            background: #f1f5f9;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .filter-tab:hover {
            background: #e2e8f0;
        }
        
        .filter-tab.active {
            background: #4f46e5;
            color: white;
        }
        
        .dark .filter-tab {
            background: #222222;
        }
        
        .dark .filter-tab:hover {
            background: #333333;
        }
        
        /* Live Exam Management */
        .live-exam-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 15px;
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }
        
        .dark .live-exam-card {
            background: #111111;
            border-color: #333333;
        }
        
        .live-exam-card:hover {
            border-color: #4f46e5;
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .exam-status {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 600;
        }
        
        .status-ongoing {
            background: #10b981;
            color: white;
        }
        
        .status-upcoming {
            background: #f59e0b;
            color: white;
        }
        
        .status-ended {
            background: #64748b;
            color: white;
        }
        
        .status-draft {
            background: #8b5cf6;
            color: white;
        }
        
        .status-cancelled {
            background: #ef4444;
            color: white;
        }
        
        .exam-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        
        @media (max-width: 768px) {
            .floating-math-btn {
                top: 70px;
                right: 10px;
                width: 45px;
                height: 45px;
                font-size: 18px;
            }
            
            .math-symbols-panel {
                width: 300px;
                right: 10px;
                top: 20px !important;
            }
            
            .hamburger-dropdown {
                min-width: 160px;
                right: -10px;
            }
            
            .group-grid {
                grid-template-columns: 1fr;
            }
            
            .exam-actions {
                flex-direction: column;
            }
        }
        
        /* Fix for keyboard opening */
        @media (max-height: 600px) {
            .math-symbols-panel {
                max-height: 50vh;
                top: 10px !important;
            }
        }
        
        /* Highlight for rank */
        .highlighted-row {
            background-color: #fef3c7 !important;
            border-color: #f59e0b !important;
            animation: highlight-pulse 2s ease-in-out;
        }
        
        .dark .highlighted-row {
            background-color: #451a03 !important;
            border-color: #f59e0b !important;
        }
        
        @keyframes highlight-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        
        /* Footer active state */
        .nav-item.active {
            color: #4f46e5 !important;
        }
        
        .nav-item.active i {
            color: #4f46e5 !important;
        }
        
        .dark .nav-item.active {
            color: #818cf8 !important;
        }
        
        .dark .nav-item.active i {
            color: #818cf8 !important;
        }
    </style>
    
    <!-- Tailwind Dark Mode Config -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        'en': ['Outfit', 'sans-serif'],
                        'bn': ['Hind Siliguri', 'sans-serif']
                    },
                    colors: {
                        dark: {
                            primary: '#0a0a0a',
                            secondary: '#111111',
                            tertiary: '#222222'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="text-slate-800 h-screen flex flex-col overflow-hidden bg-slate-50 dark:bg-black">

    <!-- Auth Screen -->
    <div id="auth-screen" class="fixed inset-0 z-50 bg-white dark:bg-black flex flex-col items-center justify-center p-6">
        <div class="w-20 h-20 bg-gradient-to-r from-emerald-500 to-teal-600 rounded-2xl flex items-center justify-center text-white text-3xl mb-4 shadow-xl">
            <i class="fas fa-chalkboard-teacher"></i>
        </div>
        <h1 class="text-3xl font-bold text-slate-800 dark:text-white mb-2 font-en">Quick<span class="text-emerald-600">Z</span></h1>
        <p class="text-sm text-slate-500 dark:text-slate-400 mb-6">Teacher Panel</p>
        
        <!-- Teacher Login Form -->
        <div class="w-full max-w-sm space-y-3">
            <input type="email" id="t-email" class="w-full p-4 bg-slate-50 dark:bg-dark-secondary border border-slate-200 dark:border-dark-tertiary rounded-xl outline-none dark:text-white" placeholder="Teacher Email">
            <div class="relative">
                <input type="password" id="t-pass" class="w-full p-4 bg-slate-50 dark:bg-dark-secondary border border-slate-200 dark:border-dark-tertiary rounded-xl outline-none dark:text-white" placeholder="Teacher Password">
                <i class="fas fa-eye absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 cursor-pointer p-2" onclick="AuthUI.togglePass('t-pass', this)"></i>
            </div>
            <button onclick="Auth.teacherLogin()" id="teacher-login-btn" class="w-full bg-gradient-to-r from-emerald-500 to-teal-600 text-white py-4 rounded-xl font-bold shadow-lg login-btn">
                <span class="btn-text">Teacher Login</span>
                <div class="loader-container">
                    <div class="loader" style="width: 20px; height: 20px; border-width: 2px;"></div>
                </div>
            </button>
        </div>
    </div>

    <!-- App Container -->
    <main id="app-container" class="flex-1 overflow-y-auto hidden pb-24 dark:bg-black"></main>

    <!-- Teacher Nav -->
    <nav id="teacher-nav" class="fixed bottom-0 w-full bg-white dark:bg-dark-secondary border-t dark:border-dark-tertiary h-16 flex justify-around items-center z-40 hidden shadow-[0_-5px_15px_rgba(0,0,0,0.05)]">
        <button onclick="Router.teacher('create')" class="nav-item text-slate-400 flex flex-col items-center"><i class="fas fa-plus-circle text-xl"></i><span class="text-[10px] font-bold">Create</span></button>
        <button onclick="Router.teacher('rank')" class="nav-item text-slate-400 flex flex-col items-center"><i class="fas fa-trophy text-xl"></i><span class="text-[10px] font-bold">Rank</span></button>
        <button onclick="Router.teacher('folders')" class="nav-item text-slate-400 flex flex-col items-center"><i class="fas fa-folder text-xl"></i><span class="text-[10px] font-bold">Folders</span></button>
        <button onclick="Router.teacher('management')" class="nav-item text-slate-400 flex flex-col items-center"><i class="fas fa-tasks text-xl"></i><span class="text-[10px] font-bold">Manage</span></button>
    </nav>

    <!-- Teacher Header -->
    <div id="teacher-header" class="fixed top-0 w-full bg-white/95 dark:bg-dark-secondary/95 backdrop-blur border-b dark:border-dark-tertiary h-14 flex justify-between items-center px-4 z-40 hidden">
        <div class="font-bold font-en text-slate-800 dark:text-white">Teacher<span class="text-indigo-600">Panel</span></div>
        <div class="flex items-center gap-3">
            <!-- Group Switcher -->
            <div class="group-switcher" id="group-switcher-container">
                <button class="group-switcher-btn" onclick="Teacher.toggleGroupSwitcher()">
                    <i class="fas fa-users"></i>
                    <span id="current-group-name" style="max-width: 100px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">Select Group</span>
                    <i class="fas fa-chevron-down"></i>
                </button>
                <div class="group-switcher-dropdown dark:bg-dark-secondary dark:border-dark-tertiary" id="group-switcher-dropdown">
                    <!-- Groups will be loaded here -->
                </div>
            </div>
            
            <!-- Teacher Code removed from header as requested -->
            <div class="hamburger-menu">
                <button class="hamburger-btn" onclick="Teacher.toggleHamburgerMenu(event)">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="hamburger-dropdown dark:bg-dark-secondary dark:border-dark-tertiary" id="hamburger-menu">
                    <div class="hamburger-item dark-mode" onclick="toggleDarkMode(); Teacher.toggleHamburgerMenu()">
                        <i class="fas fa-moon"></i>
                        <span>Dark Mode</span>
                    </div>
                    <div class="hamburger-item settings" onclick="Teacher.viewProfile(); Teacher.toggleHamburgerMenu()">
                        <i class="fas fa-user"></i>
                        <span>My Profile</span>
                    </div>
                    <div class="hamburger-item change-password" onclick="Teacher.changePassword(); Teacher.toggleHamburgerMenu()">
                        <i class="fas fa-key"></i>
                        <span>Change Password</span>
                    </div>
                    <div class="hamburger-item logout" onclick="Auth.confirmLogout(); Teacher.toggleHamburgerMenu()">
                        <i class="fas fa-power-off"></i>
                        <span>Logout</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Math Button (For Teacher Question Creation) -->
    <button id="floating-math-btn" class="floating-math-btn hidden">
        <i class="fas fa-square-root-alt"></i>
    </button>
    
    <!-- Math Symbols Panel -->
    <div id="math-symbols-panel" class="math-symbols-panel">
        <button class="math-panel-close" onclick="MathEditor.closePanel()">
            <i class="fas fa-times"></i>
        </button>
        
        <div class="symbol-group">
            <div class="symbol-group-title">Basic Operations</div>
            <div class="symbol-buttons">
                <button class="symbol-btn" onclick="MathEditor.insertAtCursor('+')">+</button>
                <button class="symbol-btn" onclick="MathEditor.insertAtCursor('-')">-</button>
                <button class="symbol-btn" onclick="MathEditor.insertAtCursor('\\times')">×</button>
                <button class="symbol-btn" onclick="MathEditor.insertAtCursor('\\div')">÷</button>
                <button class="symbol-btn" onclick="MathEditor.insertAtCursor('=')">=</button>
                <button class="symbol-btn" onclick="MathEditor.insertAtCursor('\\neq')">≠</button>
                <button class="symbol-btn" onclick="MathEditor.insertAtCursor('\\approx')">≈</button>
                <button class="symbol-btn" onclick="MathEditor.insertAtCursor('\\pm')">±</button>
                <button class="symbol-btn" onclick="MathEditor.insertAtCursor('\\mp')">∓</button>
            </div>
        </div>
        
        <div class="symbol-group">
            <div class="symbol-group-title">Fractions & Roots</div>
            <div class="symbol-buttons">
                <button class="symbol-btn" onclick="MathEditor.insertAtCursor('\\frac{}{}')">½</button>
                <button class="symbol-btn" onclick="MathEditor.insertAtCursor('\\sqrt{}')">√</button>
                <button class="symbol-btn" onclick="MathEditor.insertAtCursor('\\sqrt[]{}')">ⁿ√</button>
                <button class="symbol-btn" onclick="MathEditor.insertAtCursor('^{}')">x²</button>
                <button class="symbol-btn" onclick="MathEditor.insertAtCursor('_{}')">x₁</button>
                <button class="symbol-btn" onclick="MathEditor.insertAtCursor('\\frac{d}{dx}')">d/dx</button>
                <button class="symbol-btn" onclick="MathEditor.insertAtCursor('\\int')">∫</button>
                <button class="symbol-btn" onclick="MathEditor.insertAtCursor('\\int_{}^{}')">∫ₐᵇ</button>
                <button class="symbol-btn" onclick="MathEditor.insertAtCursor('\\sum')">∑</button>
            </div>
        </div>
        
        <div class="symbol-group">
            <div class="symbol-group-title">Greek Letters</div>
            <div class="symbol-buttons">
                <button class="symbol-btn" onclick="MathEditor.insertAtCursor('\\alpha')">α</button>
                <button class="symbol-btn" onclick="MathEditor.insertAtCursor('\\beta')">β</button>
                <button class="symbol-btn" onclick="MathEditor.insertAtCursor('\\gamma')">γ</button>
                <button class="symbol-btn" onclick="MathEditor.insertAtCursor('\\pi')">π</button>
                <button class="symbol-btn" onclick="MathEditor.insertAtCursor('\\theta')">θ</button>
                <button class="symbol-btn" onclick="MathEditor.insertAtCursor('\\phi')">φ</button>
                <button class="symbol-btn" onclick="MathEditor.insertAtCursor('\\omega')">ω</button>
                <button class="symbol-btn" onclick="MathEditor.insertAtCursor('\\Delta')">Δ</button>
            </div>
        </div>
        
        <div class="symbol-group">
            <div class="symbol-group-title">Arrows</div>
            <div class="symbol-buttons">
                <button class="symbol-btn" onclick="MathEditor.insertAtCursor('\\to')">→</button>
                <button class="symbol-btn" onclick="MathEditor.insertAtCursor('\\rightarrow')">→</button>
                <button class="symbol-btn" onclick="MathEditor.insertAtCursor('\\leftarrow')">←</button>
                <button class="symbol-btn" onclick="MathEditor.insertAtCursor('\\uparrow')">↑</button>
                <button class="symbol-btn" onclick="MathEditor.insertAtCursor('\\downarrow')">↓</button>
                <button class="symbol-btn" onclick="MathEditor.insertAtCursor('\\leftrightarrow')">↔</button>
                <button class="symbol-btn" onclick="MathEditor.insertAtCursor('\\Rightarrow')">⇒</button>
                <button class="symbol-btn" onclick="MathEditor.insertAtCursor('\\Leftrightarrow')">⇔</button>
            </div>
        </div>
        
        <div class="symbol-group">
            <div class="symbol-group-title">Vectors & Sets</div>
            <div class="symbol-buttons">
                <button class="symbol-btn" onclick="MathEditor.insertAtCursor('\\vec{}')">v⃗</button>
                <button class="symbol-btn" onclick="MathEditor.insertAtCursor('\\hat{}')">â</button>
                <button class="symbol-btn" onclick="MathEditor.insertAtCursor('\\in')">∈</button>
                <button class="symbol-btn" onclick="MathEditor.insertAtCursor('\\subset')">⊂</button>
                <button class="symbol-btn" onclick="MathEditor.insertAtCursor('\\cup')">∪</button>
                <button class="symbol-btn" onclick="MathEditor.insertAtCursor('\\cap')">∩</button>
                <button class="symbol-btn" onclick="MathEditor.insertAtCursor('\\emptyset')">∅</button>
                <button class="symbol-btn" onclick="MathEditor.insertAtCursor('\\forall')">∀</button>
            </div>
        </div>
        
        <div class="symbol-group">
            <div class="symbol-group-title">Relations & Absolute</div>
            <div class="symbol-buttons">
                <button class="symbol-btn" onclick="MathEditor.insertAtCursor('\\leq')">≤</button>
                <button class="symbol-btn" onclick="MathEditor.insertAtCursor('\\geq')">≥</button>
                <button class="symbol-btn" onclick="MathEditor.insertAtCursor('\\ll')">≪</button>
                <button class="symbol-btn" onclick="MathEditor.insertAtCursor('\\gg')">≫</button>
                <button class="symbol-btn" onclick="MathEditor.insertAtCursor('\\sim')">∼</button>
                <button class="symbol-btn" onclick="MathEditor.insertAtCursor('\\cong')">≅</button>
                <button class="symbol-btn" onclick="MathEditor.insertAtCursor('\\propto')">∝</button>
                <button class="symbol-btn" onclick="MathEditor.insertAtCursor('\\infty')">∞</button>
                <button class="symbol-btn" onclick="MathEditor.insertAtCursor('\\lvert \\rvert')">|x|</button>
            </div>
        </div>
        
        <div class="symbol-group">
            <div class="symbol-group-title">Advanced</div>
            <div class="symbol-buttons">
                <button class="symbol-btn" onclick="MathEditor.insertAtCursor('\\lim')">lim</button>
                <button class="symbol-btn" onclick="MathEditor.insertAtCursor('\\lim_{x \\to }')">lim x→</button>
                <button class="symbol-btn" onclick="MathEditor.insertAtCursor('\\oint')">∮</button>
                <button class="symbol-btn" onclick="MathEditor.insertAtCursor('\\nabla')">∇</button>
                <button class="symbol-btn" onclick="MathEditor.insertAtCursor('\\partial')">∂</button>
                <button class="symbol-btn" onclick="MathEditor.insertAtCursor('\\therefore')">∴</button>
                <button class="symbol-btn" onclick="MathEditor.insertAtCursor('\\because')">∵</button>
                <button class="symbol-btn" onclick="MathEditor.insertAtCursor('\\angle')">∠</button>
            </div>
        </div>
    </div>

    <!-- LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, getDoc, updateDoc, deleteDoc, query, where, orderBy, onSnapshot, writeBatch, setDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB4A6r2JlK_P-29fmC8LSi8gz-HjzFA4CQ",
            authDomain: "exam-611e5.firebaseapp.com",
            projectId: "exam-611e5",
            storageBucket: "exam-611e5.firebasestorage.app",
            messagingSenderId: "887013693688",
            appId: "1:887013693688:web:35cedd5b463bf642fa030d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Global State & Cache
        window.AppState = { 
            role: null, // 'teacher'
            darkMode: false,
            currentUser: null,
            teacherProfile: null,
            selectedGroup: JSON.parse(localStorage.getItem('selectedGroup')) || null,
            currentPage: 'create' // ট্র্যাক করার জন্য কোন পেজে আছে
        };
        window.ExamCache = {}; 
        window.unsubscribes = [];
        window.folderStructure = { live: [], mock: [], uncategorized: [] };
        window.folders = [];
        window.currentFocusedTextarea = null;
        window.questionMode = 'manual';
        window.Teacher = {
            questions: [],
            currentQuestion: null,
            selectedFolder: null,
            teacherCode: null,
            teacherGroups: [],
            selectedGroup: null
        };

        // Initialize dark mode from localStorage
        if (localStorage.getItem('darkMode') === 'true') {
            document.documentElement.classList.add('dark');
            window.AppState.darkMode = true;
        }

        // Auto resize textarea function
        window.autoResizeTextarea = function(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = (textarea.scrollHeight) + 'px';
        };

        const clearListeners = () => { window.unsubscribes.forEach(u => u()); window.unsubscribes = []; };

        // Real-time sync function
        const initRealTimeSync = () => {
            if (!AppState.selectedGroup || !AppState.currentUser) return;
            
            // ১. ক্লিয়ার পুরাতন লিসেনার
            window.unsubscribes.forEach(u => u());
            window.unsubscribes = [];
            
            // ২. ফোল্ডার স্ট্রাকচার লিসেনার
            const folderDocRef = doc(db, "folderStructures", `${AppState.currentUser.id}_${AppState.selectedGroup.id}`);
            const unsubFolders = onSnapshot(folderDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    window.folderStructure = docSnap.data();
                    updateUIRendering();
                } else {
                    // নতুন গ্রুপের জন্য ডিফল্ট ফোল্ডার স্ট্রাকচার
                    window.folderStructure = { live: [], mock: [], uncategorized: [] };
                    updateUIRendering();
                }
            });
            window.unsubscribes.push(unsubFolders);
            
            // ৩. এক্সাম লিসেনার
            const q = query(
                collection(db, "exams"),
                where("groupId", "==", AppState.selectedGroup.id),
                where("createdBy", "==", AppState.currentUser.id)
            );
            const unsubExams = onSnapshot(q, (snap) => {
                window.ExamCache = {};
                snap.forEach(d => {
                    window.ExamCache[d.id] = { id: d.id, ...d.data() };
                });
                updateUIRendering();
            });
            window.unsubscribes.push(unsubExams);
        };

        // UI আপডেট করার জন্য কমন ফাংশন
        const updateUIRendering = () => {
            const container = document.getElementById('app-container');
            if (!container) return;
            
            // বর্তমানে কোন পেজে আছে তা চেক করে সেই পেজ রি-রেন্ডার করা
            if (container.innerHTML.includes('Folder Management')) {
                Teacher.renderFolderTree();
                Teacher.renderUncategorizedExams();
            }
            if (container.innerHTML.includes('Live Exam Rankings')) {
                Teacher.rankView();
            }
            if (container.innerHTML.includes('Live Exam Management')) {
                Teacher.liveExamManagementView();
            }
        };

        // Firebase helper function to save folder structure
        const saveFolderStructureToFirebase = async () => {
            if (!AppState.currentUser || !AppState.selectedGroup) return;
            
            try {
                const folderDocRef = doc(db, "folderStructures", `${AppState.currentUser.id}_${AppState.selectedGroup.id}`);
                await setDoc(folderDocRef, {
                    ...window.folderStructure,
                    updatedAt: new Date()
                }, { merge: true });
            } catch (error) {
                console.error("Folder Sync Error:", error);
            }
        };

        // Three Dot Menu Handler
        document.addEventListener('click', function(e) {
            // Close all dropdowns when clicking outside
            if (!e.target.closest('.three-dot-menu') && !e.target.closest('.dot-menu-dropdown')) {
                document.querySelectorAll('.dot-menu-dropdown').forEach(dropdown => {
                    dropdown.classList.remove('show');
                });
            }
            
            // Close math symbols panel when clicking outside
            if (!e.target.closest('#math-symbols-panel') && !e.target.closest('#floating-math-btn')) {
                document.getElementById('math-symbols-panel').classList.remove('show');
            }
            
            // Close hamburger menu when clicking outside
            if (!e.target.closest('.hamburger-menu')) {
                document.getElementById('hamburger-menu').classList.remove('show');
            }
            
            // Close group switcher when clicking outside
            if (!e.target.closest('.group-switcher')) {
                document.getElementById('group-switcher-dropdown').classList.remove('show');
            }
        });

        // Math Editor Functions
        window.MathEditor = {
            currentField: null,
            
            init: function() {
                // Track focused textareas for math insertion
                document.addEventListener('focusin', function(e) {
                    if (e.target.tagName === 'TEXTAREA' && 
                        (e.target.id.includes('question') || e.target.id.includes('option') || e.target.id.includes('explanation'))) {
                        window.currentFocusedTextarea = e.target;
                    }
                });
                
                // Setup floating math button
                const floatingMathBtn = document.getElementById('floating-math-btn');
                if (floatingMathBtn) {
                    floatingMathBtn.addEventListener('click', function() {
                        const panel = document.getElementById('math-symbols-panel');
                        panel.classList.toggle('show');
                        // Add fixed position class for mobile
                        if (panel.classList.contains('show')) {
                            panel.classList.add('fixed-position');
                        } else {
                            panel.classList.remove('fixed-position');
                        }
                    });
                }
                
                // Setup math preview buttons
                document.addEventListener('click', function(e) {
                    if (e.target.classList.contains('math-preview-btn') || e.target.closest('.math-preview-btn')) {
                        const btn = e.target.classList.contains('math-preview-btn') ? e.target : e.target.closest('.math-preview-btn');
                        const textareaId = btn.dataset.target;
                        const textarea = document.getElementById(textareaId);
                        
                        if (!textarea) return;
                        
                        // Create or get overlay
                        let overlay = document.getElementById('overlay-' + textareaId);
                        if (!overlay) {
                            overlay = document.createElement('div');
                            overlay.id = 'overlay-' + textareaId;
                            overlay.className = 'math-render-overlay';
                            overlay.style.display = 'none';
                            textarea.parentNode.style.position = 'relative';
                            textarea.parentNode.insertBefore(overlay, textarea.nextSibling);
                        }
                        
                        if (overlay.style.display === 'none') {
                            // Show math render
                            overlay.style.display = 'block';
                            textarea.classList.add('math-mode');
                            btn.innerHTML = '<i class="fas fa-code"></i>';
                            
                            // Update content
                            this.updateMathOverlay(textareaId);
                        } else {
                            // Hide math render
                            overlay.style.display = 'none';
                            textarea.classList.remove('math-mode');
                            btn.innerHTML = '<i class="fas fa-eye"></i>';
                        }
                    }
                }.bind(this));
                
                // Auto-update preview on input
                document.addEventListener('input', function(e) {
                    if (e.target.tagName === 'TEXTAREA' && 
                        (e.target.id.includes('question') || e.target.id.includes('option') || e.target.id.includes('explanation'))) {
                        const overlayId = 'overlay-' + e.target.id;
                        const overlay = document.getElementById(overlayId);
                        if (overlay && overlay.style.display !== 'none') {
                            MathEditor.updateMathOverlay(e.target.id);
                        }
                    }
                });
                
                // Handle keyboard visibility on mobile
                window.addEventListener('resize', function() {
                    const panel = document.getElementById('math-symbols-panel');
                    if (panel.classList.contains('show')) {
                        panel.classList.add('fixed-position');
                    }
                });
            },
            
            closePanel: function() {
                const panel = document.getElementById('math-symbols-panel');
                panel.classList.remove('show');
                panel.classList.remove('fixed-position');
            },
            
            insertAtCursor: function(symbol) {
                if (!window.currentFocusedTextarea) return;
                
                const textarea = window.currentFocusedTextarea;
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                const text = textarea.value;
                
                // Replace selected text with symbol
                const before = text.substring(0, start);
                const after = text.substring(end);
                
                // Handle special symbols with placeholders
                let finalSymbol = symbol;
                let cursorPos = before.length + symbol.length;
                
                if (symbol.includes('{}')) {
                    // Place cursor inside first braces
                    cursorPos = before.length + symbol.indexOf('{}') + 1;
                }
                
                textarea.value = before + symbol + after;
                textarea.selectionStart = cursorPos;
                textarea.selectionEnd = cursorPos;
                
                // Trigger input event
                textarea.dispatchEvent(new Event('input'));
                textarea.focus();
                
                // CLOSE PANEL AFTER INSERTION
                MathEditor.closePanel();
                
                // Update overlay if active
                const overlayId = 'overlay-' + textarea.id;
                const overlay = document.getElementById(overlayId);
                if (overlay && overlay.style.display !== 'none') {
                    MathEditor.updateMathOverlay(textarea.id);
                }
            },
            
            updateMathOverlay: function(textareaId) {
                const textarea = document.getElementById(textareaId);
                const overlay = document.getElementById('overlay-' + textareaId);
                
                if (!textarea || !overlay) return;
                
                const content = textarea.value;
                
                // Clear previous content
                overlay.innerHTML = '';
                
                if (!content.trim()) {
                    overlay.innerHTML = '<div class="text-center text-slate-400 p-4">No content</div>';
                    return;
                }
                
                // Create preview content
                const previewContent = document.createElement('div');
                previewContent.className = 'math-render';
                
                // Process content for MathJax - wrap in \( \) if needed
                let processedContent = content;
                
                // Check if content contains LaTeX but not wrapped
                const hasLatex = /\\[a-zA-Z]|\\[\[\]\(\)]|\^|_|\\frac|\\sqrt|\\sum|\\int|\\lim/.test(content);
                const isWrapped = /\\\(.*\\\)|\\\[.*\\\]/.test(content);
                
                if (hasLatex && !isWrapped) {
                    processedContent = `\\(${content}\\)`;
                }
                
                previewContent.innerHTML = processedContent;
                overlay.appendChild(previewContent);
                
                // Typeset with MathJax
                try {
                    MathJax.typeset([previewContent]);
                } catch (error) {
                    console.error('MathJax typesetting error:', error);
                    overlay.innerHTML = `<div class="text-red-500 p-2">Rendering error</div>`;
                }
            },
            
            renderMathInElement: function(element) {
                if (!element) return;
                
                const content = element.innerHTML;
                if (!content) return;
                
                // Check if content contains LaTeX
                if (/\\[a-zA-Z]|\\[\[\]\(\)]|\^|_|\\frac|\\sqrt|\\sum|\\int|\\lim/.test(content)) {
                    // Already has math delimiters?
                    if (!/\\\(.*\\\)|\\\[.*\\\]/.test(content)) {
                        element.innerHTML = `\\(${content}\\)`;
                    }
                    
                    // Typeset with MathJax
                    try {
                        MathJax.typeset([element]);
                    } catch (error) {
                        console.error('MathJax typesetting error:', error);
                    }
                }
            }
        };
        
        // Initialize Math Editor
        MathEditor.init();

        // Dark Mode Toggle
        window.toggleDarkMode = function() {
            window.AppState.darkMode = !window.AppState.darkMode;
            if (window.AppState.darkMode) {
                document.documentElement.classList.add('dark');
                localStorage.setItem('darkMode', 'true');
            } else {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('darkMode', 'false');
            }
            
            // Re-render math if needed
            document.querySelectorAll('.math-render-overlay').forEach(overlay => {
                if (overlay.style.display !== 'none') {
                    const textareaId = overlay.id.replace('overlay-', '');
                    MathEditor.updateMathOverlay(textareaId);
                }
            });
        };

        // --- AUTH UI ---
        window.AuthUI = {
            togglePass: (id, el) => {
                const i = document.getElementById(id);
                if(i.type === 'password') { i.type = 'text'; el.classList.remove('fa-eye'); el.classList.add('fa-eye-slash'); }
                else { i.type = 'password'; el.classList.remove('fa-eye-slash'); el.classList.add('fa-eye'); }
            },
            
            showLoginLoading: (btnId) => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    btn.classList.add('loading');
                    btn.disabled = true;
                }
            },
            
            hideLoginLoading: (btnId) => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    btn.classList.remove('loading');
                    btn.disabled = false;
                }
            }
        };

        // --- AUTHENTICATION ---
        window.Auth = {
            teacherLogin: async () => {
                AuthUI.showLoginLoading('teacher-login-btn');
                const email = document.getElementById('t-email').value.trim();
                const password = document.getElementById('t-pass').value.trim();
                
                if (!email || !password) {
                    AuthUI.hideLoginLoading('teacher-login-btn');
                    Swal.fire('Error', 'Please enter email and password', 'error');
                    return;
                }
                
                try {
                    const teachersQuery = query(collection(db, "teachers"), where("email", "==", email));
                    const querySnapshot = await getDocs(teachersQuery);
                    
                    if (querySnapshot.empty) {
                        AuthUI.hideLoginLoading('teacher-login-btn');
                        Swal.fire('Error', 'Teacher not found', 'error');
                        return;
                    }
                    
                    let teacherFound = false;
                    let teacherData = null;
                    let teacherId = null;
                    
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        if (data.password === password) {
                            teacherFound = true;
                            teacherData = data;
                            teacherId = doc.id;
                        }
                    });
                    
                    if (teacherFound) {
                        // Check if teacher is disabled
                        if (teacherData.disabled) {
                            AuthUI.hideLoginLoading('teacher-login-btn');
                            Swal.fire('Account Disabled', 'Your account has been disabled by admin. Please contact administrator.', 'error');
                            return;
                        }
                        
                        AppState.role = 'teacher';
                        AppState.currentUser = { id: teacherId, ...teacherData };
                        AuthUI.hideLoginLoading('teacher-login-btn');
                        Auth.finalizeTeacher();
                    } else {
                        AuthUI.hideLoginLoading('teacher-login-btn');
                        Swal.fire('Error', 'Invalid email or password', 'error');
                    }
                } catch(e) { 
                    AuthUI.hideLoginLoading('teacher-login-btn');
                    Swal.fire('Error', 'Connection Error: ' + e.message, 'error'); 
                }
            },
            
            finalizeTeacher: () => {
                localStorage.setItem('teacher_sess','true'); 
                localStorage.setItem('teacher_email', AppState.currentUser.email);
                localStorage.setItem('teacher_data', JSON.stringify(AppState.currentUser));
                // Check if teacher has completed profile
                if (!AppState.currentUser.fullName || !AppState.currentUser.phone) {
                    // Teacher needs to complete profile
                    Router.showTeacherProfileForm();
                } else {
                    Router.initTeacher();
                }
            },
            
            reloadTeacherSession: async () => {
                const storedData = localStorage.getItem('teacher_data');
                if (!storedData) {
                    document.getElementById('auth-screen').classList.remove('hidden');
                    return;
                }
                
                try {
                    const teacherData = JSON.parse(storedData);
                    const docRef = doc(db, "teachers", teacherData.id);
                    const docSnap = await getDoc(docRef);
                    
                    if (docSnap.exists()) {
                        AppState.role = 'teacher';
                        AppState.currentUser = { id: docSnap.id, ...docSnap.data() };
                        
                        // গ্রুপ রিকভারি
                        const lastGroupId = localStorage.getItem('selectedGroup');
                        if (lastGroupId) {
                            AppState.selectedGroup = JSON.parse(lastGroupId);
                        }
                        
                        initRealTimeSync();
                        Router.initTeacher();
                    } else {
                        Auth.logout();
                    }
                } catch (e) {
                    console.error("Session Error:", e);
                    Auth.logout();
                }
            },
            
            confirmLogout: async () => { 
                const { value: teacherCode } = await Swal.fire({
                    title: 'Confirm Logout',
                    text: "Please enter your Teacher Code to logout",
                    input: 'text',
                    showCancelButton: true,
                    inputValidator: (value) => {
                        if (!value) return 'Teacher code is required!';
                        if (value !== AppState.currentUser.teacherCode) {
                            return 'Incorrect Teacher Code!';
                        }
                    }
                });
                
                if (teacherCode) {
                    Swal.fire({ 
                        title: 'Logout?', 
                        icon: 'warning', 
                        showCancelButton: true, 
                        confirmButtonText: 'Yes', 
                        confirmButtonColor: '#ef4444' 
                    }).then((r)=>{if(r.isConfirmed) Auth.logout()});
                }
            },
            
            logout: async () => { 
                clearListeners(); 
                localStorage.removeItem('teacher_sess');
                localStorage.removeItem('teacher_email');
                localStorage.removeItem('teacher_data');
                localStorage.removeItem('selectedGroup');
                localStorage.removeItem('folderStructure');
                AppState.role = null;
                AppState.currentUser = null;
                AppState.selectedGroup = null;
                location.reload();
            }
        };

        // --- ROUTER ---
        window.Router = {
            initTeacher: () => {
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                document.getElementById('app-container').classList.add('pt-16');
                document.getElementById('teacher-nav').classList.remove('hidden');
                document.getElementById('teacher-nav').classList.add('flex');
                document.getElementById('teacher-header').classList.remove('hidden');
                document.getElementById('teacher-header').classList.add('flex');
                
                // Load groups for switcher
                Teacher.loadGroupsForSwitcher();
                
                // Check if group is selected
                if (!AppState.selectedGroup) {
                    Teacher.selectGroupView();
                } else {
                    Teacher.createView();
                }
            },
            
            showTeacherProfileForm: () => {
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                document.getElementById('app-container').innerHTML = `
                    <div class="p-5 max-w-md mx-auto">
                        <div class="text-center mb-6">
                            <div class="w-16 h-16 bg-gradient-to-r from-emerald-500 to-teal-600 rounded-2xl flex items-center justify-center text-white text-2xl mb-3 mx-auto">
                                <i class="fas fa-user-graduate"></i>
                            </div>
                            <h2 class="text-xl font-bold dark:text-white">Complete Your Profile</h2>
                            <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">Please provide your information to continue</p>
                        </div>
                        
                        <div class="teacher-profile-form">
                            <div class="mb-4">
                                <label class="block text-sm font-bold mb-1 dark:text-white">Full Name</label>
                                <input type="text" id="teacher-fullname" class="w-full p-3 border dark:border-dark-tertiary dark:bg-black dark:text-white rounded-xl" placeholder="Enter your full name" required>
                            </div>
                            
                            <div class="mb-6">
                                <label class="block text-sm font-bold mb-1 dark:text-white">Phone Number</label>
                                <input type="tel" id="teacher-phone" class="w-full p-3 border dark:border-dark-tertiary dark:bg-black dark:text-white rounded-xl" placeholder="Enter your phone number" required>
                            </div>
                            
                            <button onclick="Router.saveTeacherProfile()" class="w-full bg-gradient-to-r from-emerald-500 to-teal-600 text-white py-3 rounded-xl font-bold shadow-lg">
                                Save Profile & Continue
                            </button>
                        </div>
                    </div>
                `;
            },
            
            saveTeacherProfile: async () => {
                const fullName = document.getElementById('teacher-fullname').value.trim();
                const phone = document.getElementById('teacher-phone').value.trim();
                
                if (!fullName || !phone) {
                    Swal.fire('Error', 'Please fill all fields', 'error');
                    return;
                }
                
                // Generate unique teacher code
                const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
                const numbers = '0123456789';
                let teacherCode = '';
                
                // Generate 5 random capital letters
                for (let i = 0; i < 5; i++) {
                    teacherCode += letters.charAt(Math.floor(Math.random() * letters.length));
                }
                
                teacherCode += '-';
                
                // Generate 5 random numbers
                for (let i = 0; i < 5; i++) {
                    teacherCode += numbers.charAt(Math.floor(Math.random() * numbers.length));
                }
                
                try {
                    // Update teacher profile in Firestore
                    await updateDoc(doc(db, "teachers", AppState.currentUser.id), {
                        fullName: fullName,
                        phone: phone,
                        teacherCode: teacherCode,
                        profileCompleted: true,
                        updatedAt: new Date()
                    });
                    
                    // Update local state
                    AppState.currentUser.fullName = fullName;
                    AppState.currentUser.phone = phone;
                    AppState.currentUser.teacherCode = teacherCode;
                    AppState.currentUser.profileCompleted = true;
                    
                    // Update localStorage
                    localStorage.setItem('teacher_data', JSON.stringify(AppState.currentUser));
                    
                    Swal.fire('Success', 'Profile saved successfully!', 'success').then(() => {
                        Router.initTeacher();
                    });
                } catch (error) {
                    Swal.fire('Error', 'Failed to save profile: ' + error.message, 'error');
                }
            },
            
            teacher: (p) => {
                clearListeners();
                AppState.currentPage = p;
                
                // Update footer highlighting
                document.querySelectorAll('#teacher-nav .nav-item').forEach(el => {
                    el.classList.remove('active', 'text-indigo-600');
                    el.classList.add('text-slate-400');
                });
                
                const btn = document.querySelector(`button[onclick="Router.teacher('${p}')"]`);
                if (btn) {
                    btn.classList.add('active', 'text-indigo-600');
                    btn.classList.remove('text-slate-400');
                }
                
                // Hide floating math button for all pages except create
                if (p !== 'create') {
                    document.getElementById('floating-math-btn').classList.add('hidden');
                    document.getElementById('math-symbols-panel').classList.remove('show');
                }
                
                // Check if group is selected for major sections
                const pagesRequiringGroup = ['create', 'rank', 'folders', 'management'];
                if (pagesRequiringGroup.includes(p) && !AppState.selectedGroup) {
                    Teacher.selectGroupView(p);
                    return;
                }
                
                if(p==='create') Teacher.createView();
                if(p==='rank') Teacher.rankView();
                if(p==='folders') Teacher.foldersView();
                if(p==='management') Teacher.managementView();
            }
        };

        // --- TEACHER PANEL ---
        window.Teacher = {
            questions: [],
            currentQuestion: null,
            selectedFolder: null,
            teacherGroups: [],
            topScorerId: null,
            topAccuracyId: null,
            
            toggleHamburgerMenu: function(event) {
                if (event) {
                    event.stopPropagation();
                }
                const menu = document.getElementById('hamburger-menu');
                if (menu) {
                    menu.classList.toggle('show');
                }
            },
            
            toggleGroupSwitcher: function() {
                const dropdown = document.getElementById('group-switcher-dropdown');
                if (dropdown) {
                    dropdown.classList.toggle('show');
                }
            },
            
            loadGroupsForSwitcher: async function() {
                try {
                    const groupsQuery = query(collection(db, "groups"), 
                        where("teacherId", "==", AppState.currentUser.id),
                        where("archived", "==", false),
                        orderBy("createdAt", "desc"));
                    const groupsSnap = await getDocs(groupsQuery);
                    
                    const groups = [];
                    groupsSnap.forEach(doc => {
                        groups.push({ id: doc.id, ...doc.data() });
                    });
                    
                    Teacher.teacherGroups = groups;
                    
                    // Update current group name in header
                    if (AppState.selectedGroup) {
                        const currentGroup = groups.find(g => g.id === AppState.selectedGroup.id);
                        if (currentGroup) {
                            const truncatedName = currentGroup.name.length > 12 ? currentGroup.name.substring(0, 12) + '...' : currentGroup.name;
                            document.getElementById('current-group-name').textContent = truncatedName;
                        }
                    } else if (groups.length > 0) {
                        document.getElementById('current-group-name').textContent = 'Select Group';
                    }
                    
                    // Populate dropdown
                    const dropdown = document.getElementById('group-switcher-dropdown');
                    if (dropdown) {
                        if (groups.length === 0) {
                            dropdown.innerHTML = '<div class="p-3 text-sm text-slate-500">No groups found</div>';
                            return;
                        }
                        
                        let html = '';
                        groups.forEach(group => {
                            const isActive = AppState.selectedGroup && AppState.selectedGroup.id === group.id;
                            html += `
                                <div class="group-switcher-item ${isActive ? 'active' : ''}" 
                                     onclick="Teacher.switchGroup('${group.id}', '${group.name}')">
                                    <div class="font-medium">${group.name}</div>
                                    <div class="text-xs text-slate-500 mt-1">${group.groupCode}</div>
                                </div>
                            `;
                        });
                        
                        dropdown.innerHTML = html;
                    }
                } catch (error) {
                    console.error('Error loading groups for switcher:', error);
                }
            },
            
            switchGroup: async function(groupId, groupName) {
                AppState.selectedGroup = { id: groupId, name: groupName };
                localStorage.setItem('selectedGroup', JSON.stringify(AppState.selectedGroup));
                
                // Save last selected group to Firebase
                try {
                    await updateDoc(doc(db, "teachers", AppState.currentUser.id), {
                        lastGroupId: groupId,
                        updatedAt: new Date()
                    });
                } catch (error) {
                    console.error('Error saving last group:', error);
                }
                
                // Truncate the name
                const truncatedName = groupName.length > 12 ? groupName.substring(0, 12) + '...' : groupName;
                document.getElementById('current-group-name').textContent = truncatedName;
                document.getElementById('group-switcher-dropdown').classList.remove('show');
                
                // Show modal
                Swal.fire({
                    icon: 'success',
                    title: 'Group Switched',
                    text: `Now viewing: ${groupName}`,
                    timer: 1500,
                    showConfirmButton: false
                });
                
                // নতুন গ্রুপের জন্য সিঙ্ক শুরু
                initRealTimeSync();
                
                // Go to create view
                Teacher.createView();
            },
            
            changePassword: async function() {
                const { value: formValues } = await Swal.fire({
                    title: 'Change Password',
                    html:
                        '<input id="swal-old" class="swal2-input" placeholder="Current Password" type="password">' +
                        '<input id="swal-new" class="swal2-input" placeholder="New Password" type="password">' +
                        '<input id="swal-conf" class="swal2-input" placeholder="Confirm New Password" type="password">',
                    focusConfirm: false,
                    showCancelButton: true,
                    preConfirm: () => {
                        return [
                            document.getElementById('swal-old').value,
                            document.getElementById('swal-new').value,
                            document.getElementById('swal-conf').value
                        ]
                    }
                });

                if (formValues) {
                    const [oldPass, newPass, confPass] = formValues;
                    if(!oldPass || !newPass || !confPass) {
                        Swal.fire('Error', 'All fields are required', 'error');
                        return;
                    }
                    if(newPass !== confPass) {
                        Swal.fire('Error', 'New passwords do not match', 'error');
                        return;
                    }

                    // Check if old password is correct
                    if (oldPass !== AppState.currentUser.password) {
                        Swal.fire('Error', 'Current password is incorrect', 'error');
                        return;
                    }

                    try {
                        await updateDoc(doc(db, "teachers", AppState.currentUser.id), {
                            password: newPass,
                            updatedAt: new Date()
                        });

                        // Update local state
                        AppState.currentUser.password = newPass;
                        
                        // Update localStorage
                        localStorage.setItem('teacher_data', JSON.stringify(AppState.currentUser));

                        Swal.fire('Success', 'Password changed successfully', 'success');
                    } catch (error) {
                        Swal.fire('Error', 'Failed to change password: ' + error.message, 'error');
                    }
                }
            },
            
            viewProfile: function() {
                if (!AppState.currentUser) return;
                
                document.getElementById('app-container').innerHTML = `
                <div class="p-5 max-w-md mx-auto">
                    <button onclick="Router.teacher('create')" class="mb-4 text-xs font-bold text-slate-500 dark:text-slate-400">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                    
                    <div class="text-center mb-6">
                        <div class="w-20 h-20 bg-gradient-to-r from-emerald-500 to-teal-600 rounded-full flex items-center justify-center text-white text-2xl mb-3 mx-auto">
                            <i class="fas fa-user-graduate"></i>
                        </div>
                        <h2 class="text-xl font-bold dark:text-white">My Profile</h2>
                    </div>
                    
                    <div class="teacher-profile-form">
                        <div class="mb-4">
                            <label class="block text-sm font-bold mb-1 dark:text-white">Full Name</label>
                            <input type="text" id="profile-fullname" class="w-full p-3 border dark:border-dark-tertiary dark:bg-black dark:text-white rounded-xl" value="${AppState.currentUser.fullName || ''}">
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-bold mb-1 dark:text-white">Email</label>
                            <input type="email" id="profile-email" class="w-full p-3 border dark:border-dark-tertiary dark:bg-black dark:text-white rounded-xl" value="${AppState.currentUser.email}" readonly>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-bold mb-1 dark:text-white">Phone Number</label>
                            <input type="tel" id="profile-phone" class="w-full p-3 border dark:border-dark-tertiary dark:bg-black dark:text-white rounded-xl" value="${AppState.currentUser.phone || ''}">
                        </div>
                        
                        <div class="mb-6">
                            <label class="block text-sm font-bold mb-1 dark:text-white">Teacher Code</label>
                            <div class="teacher-code-badge flex justify-between items-center">
                                <span>${AppState.currentUser.teacherCode}</span>
                                <button onclick="Teacher.copyTeacherCode()" class="text-white hover:text-slate-200">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                            <p class="text-xs text-slate-500 dark:text-slate-400 mt-2">Share this code with students to connect with you</p>
                        </div>

                        <button onclick="Teacher.saveProfile()" class="w-full bg-gradient-to-r from-emerald-500 to-teal-600 text-white py-3 rounded-xl font-bold">
                            Save Profile
                        </button>
                    </div>
                </div>`;
            },
            
            copyTeacherCode: function() {
                const teacherCode = AppState.currentUser.teacherCode;
                navigator.clipboard.writeText(teacherCode).then(() => {
                    Swal.fire('Copied!', 'Teacher code copied to clipboard', 'success');
                }).catch(err => {
                    console.error('Failed to copy: ', err);
                    Swal.fire('Error', 'Failed to copy code', 'error');
                });
            },
            
            saveProfile: async function() {
                const fullName = document.getElementById('profile-fullname').value.trim();
                const phone = document.getElementById('profile-phone').value.trim();

                if (!fullName || !phone) {
                    Swal.fire('Error', 'Please fill all fields', 'error');
                    return;
                }

                try {
                    await updateDoc(doc(db, "teachers", AppState.currentUser.id), {
                        fullName: fullName,
                        phone: phone,
                        updatedAt: new Date()
                    });

                    // Update local state
                    AppState.currentUser.fullName = fullName;
                    AppState.currentUser.phone = phone;
                    
                    // Update localStorage
                    localStorage.setItem('teacher_data', JSON.stringify(AppState.currentUser));

                    Swal.fire('Success', 'Profile updated successfully', 'success');
                } catch (error) {
                    Swal.fire('Error', 'Failed to update profile: ' + error.message, 'error');
                }
            },
            
            selectGroupView: async (page = 'create') => {
                try {
                    // Load active groups (not archived)
                    const groupsQuery = query(collection(db, "groups"), 
                        where("teacherId", "==", AppState.currentUser.id),
                        where("archived", "==", false),
                        orderBy("createdAt", "desc"));
                    const groupsSnap = await getDocs(groupsQuery);
                    
                    const groups = [];
                    groupsSnap.forEach(doc => {
                        groups.push({ id: doc.id, ...doc.data() });
                    });
                    
                    if (groups.length === 0) {
                        document.getElementById('app-container').innerHTML = `
                            <div class="p-5 max-w-md mx-auto">
                                <div class="text-center mb-6">
                                    <div class="w-20 h-20 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-full flex items-center justify-center text-white text-2xl mb-3 mx-auto">
                                        <i class="fas fa-users"></i>
                                    </div>
                                    <h2 class="text-xl font-bold dark:text-white">No Groups Found</h2>
                                    <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">You need to create a group first to continue</p>
                                </div>
                                
                                <div class="bg-white dark:bg-dark-secondary p-5 rounded-2xl shadow-sm border dark:border-dark-tertiary space-y-4">
                                    <div>
                                        <label class="block text-sm font-bold mb-1 dark:text-white">Group Name</label>
                                        <input type="text" id="group-name" class="w-full p-3 border dark:border-dark-tertiary dark:bg-black dark:text-white rounded-xl" placeholder="e.g., Class 10 Batch-1">
                                    </div>
                                    
                                    <button onclick="Teacher.createGroup()" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-4 rounded-xl font-bold shadow-lg">
                                        Create Group
                                    </button>
                                </div>
                            </div>
                        `;
                        return;
                    }
                    
                    let html = `
                        <div class="p-5">
                            <h2 class="text-xl font-bold mb-6 font-en text-slate-800 dark:text-white">Select a Group</h2>
                            <p class="text-sm text-slate-500 dark:text-slate-400 mb-6">Please select a group to continue. Each group has separate questions, students, and rankings.</p>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    `;
                    
                    groups.forEach(group => {
                        html += `
                            <div class="group-card cursor-pointer" onclick="Teacher.setSelectedGroup('${group.id}', '${group.name}', '${page}')">
                                <div class="flex justify-between items-start mb-3">
                                    <div>
                                        <h3 class="font-bold text-lg dark:text-white">${group.name}</h3>
                                        <p class="text-xs text-slate-500 dark:text-slate-400">${group.studentIds ? group.studentIds.length : 0} students</p>
                                    </div>
                                </div>
                                <div class="group-code">${group.groupCode}</div>
                                <div class="text-xs text-slate-500 dark:text-slate-400 mt-3">
                                    Created: ${moment(group.createdAt?.toDate()).format('DD MMM YYYY')}
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                            
                            <div class="mt-6 bg-white dark:bg-dark-secondary p-5 rounded-2xl shadow-sm border dark:border-dark-tertiary">
                                <h3 class="font-bold text-lg mb-4 dark:text-white">Create New Group</h3>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-bold mb-1 dark:text-white">Group Name</label>
                                        <input type="text" id="group-name" class="w-full p-3 border dark:border-dark-tertiary dark:bg-black dark:text-white rounded-xl" placeholder="e.g., Class 10 Batch-1">
                                    </div>
                                    
                                    <button onclick="Teacher.createGroup()" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-4 rounded-xl font-bold shadow-lg">
                                        Create Group
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('app-container').innerHTML = html;
                } catch (error) {
                    console.error('Error loading groups:', error);
                    document.getElementById('app-container').innerHTML = '<div class="text-center p-10 text-red-500">Error loading groups</div>';
                }
            },
            
            setSelectedGroup: (groupId, groupName, page) => {
                AppState.selectedGroup = { id: groupId, name: groupName };
                localStorage.setItem('selectedGroup', JSON.stringify(AppState.selectedGroup));
                
                // Update group switcher
                Teacher.loadGroupsForSwitcher();
                
                // নতুন গ্রুপের জন্য সিঙ্ক শুরু
                initRealTimeSync();
                
                // Go to the intended page
                Router.teacher(page);
            },
            
            createView: () => {
                // Check if group is selected
                if (!AppState.selectedGroup) {
                    Teacher.selectGroupView('create');
                    return;
                }
                
                // Reset questions array to prevent carryover
                Teacher.questions = [];
                Teacher.currentQuestion = null;
                
                document.getElementById('app-container').innerHTML = `
                <div class="p-5 max-w-2xl mx-auto pb-20">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold font-en text-slate-800 dark:text-white">Teacher Dashboard</h2>
                        <div class="text-xs bg-indigo-100 dark:bg-indigo-900 text-indigo-600 dark:text-indigo-300 px-3 py-1.5 rounded-lg">
                            <i class="fas fa-users mr-1"></i> ${AppState.selectedGroup.name}
                        </div>
                    </div>
                    <div class="grid grid-cols-1 gap-4">
                        <button onclick="Teacher.renderForm('live')" class="h-36 rounded-2xl bg-gradient-to-r from-violet-600 to-indigo-600 text-white p-6 relative overflow-hidden shadow-lg transition active:scale-95 text-left group">
                            <div class="bg-white/20 w-12 h-12 rounded-full flex items-center justify-center backdrop-blur-sm mb-3"><i class="fas fa-broadcast-tower text-xl"></i></div>
                            <h3 class="text-2xl font-bold">Create Live Exam</h3>
                            <p class="text-indigo-100 text-xs mt-1">Schedule exams for specific time.</p>
                            <i class="fas fa-plus absolute right-6 top-1/2 -translate-y-1/2 text-6xl opacity-20 group-hover:scale-110 transition"></i>
                        </button>
                        <button onclick="Teacher.renderForm('mock')" class="h-36 rounded-2xl bg-gradient-to-r from-emerald-500 to-teal-600 text-white p-6 relative overflow-hidden shadow-lg transition active:scale-95 text-left group">
                            <div class="bg-white/20 w-12 h-12 rounded-full flex items-center justify-center backdrop-blur-sm mb-3"><i class="fas fa-book-reader text-xl"></i></div>
                            <h3 class="text-2xl font-bold">Create Practice</h3>
                            <p class="text-emerald-100 text-xs mt-1">Mock with Subjects & Chapters.</p>
                            <i class="fas fa-pencil-alt absolute right-6 top-1/2 -translate-y-1/2 text-6xl opacity-20 group-hover:scale-110 transition"></i>
                        </button>
                    </div>
                </div>`;
                
                // Hide floating math button initially
                document.getElementById('floating-math-btn').classList.add('hidden');
            },
            
            renderForm: (type) => {
                // Check if group is selected
                if (!AppState.selectedGroup) {
                    Teacher.selectGroupView('create');
                    return;
                }
                
                // Show floating math button only in create form
                document.getElementById('floating-math-btn').classList.remove('hidden');
                
                // Reset questions array
                Teacher.questions = [];
                Teacher.currentQuestion = null;
                
                const isLive = type === 'live';
                
                // Get subjects and chapters from both ExamCache and folderStructure
                const getSubjectsForType = (type) => {
                    const fromExams = [...new Set(Object.values(window.ExamCache)
                        .filter(e => e.type === type && e.subject)
                        .map(e => e.subject))];
                    
                    const fromFolders = window.folderStructure[type].map(s => s.name);
                    
                    return [...new Set([...fromExams, ...fromFolders])];
                };
                
                const subjects = getSubjectsForType(type);
                
                document.getElementById('app-container').innerHTML = `
                <div class="p-5 max-w-2xl mx-auto pb-20">
                    <div class="flex justify-between items-center mb-4">
                        <button onclick="Teacher.createView()" class="text-xs font-bold text-slate-500 dark:text-slate-400 flex items-center gap-1">
                            <i class="fas fa-arrow-left"></i> Back to Dashboard
                        </button>
                        <div class="text-xs bg-indigo-100 dark:bg-indigo-900 text-indigo-600 dark:text-indigo-300 px-3 py-1.5 rounded-lg">
                            <i class="fas fa-users mr-1"></i> ${AppState.selectedGroup.name}
                        </div>
                    </div>
                    <h2 class="text-xl font-bold mb-4 font-en text-slate-800 dark:text-white">Create ${isLive ? 'Live Exam' : 'Practice Test'}</h2>
                    <div class="bg-white dark:bg-dark-secondary p-5 rounded-2xl shadow-sm border dark:border-dark-tertiary space-y-4">
                        <input id="nt" class="w-full p-3 border dark:border-dark-tertiary dark:bg-black dark:text-white rounded-xl" placeholder="Exam Title">
                        <input type="hidden" id="nty" value="${type}"> 
                        
                        <!-- Subject and Chapter Fields -->
                        <div class="grid grid-cols-2 gap-3">
                            <div class="select-container">
                                <label class="block text-sm font-bold mb-1 dark:text-white">Subject</label>
                                <select id="nsub" class="w-full p-3 border dark:border-dark-tertiary dark:bg-black dark:text-white rounded-xl" ${type === 'mock' ? 'required' : ''}>
                                    <option value="">Select Subject (Optional)</option>
                                    ${subjects.map(s => `<option value="${s}">${s}</option>`).join('')}
                                </select>
                            </div>
                            <div class="select-container">
                                <label class="block text-sm font-bold mb-1 dark:text-white">Chapter</label>
                                <select id="nchap" class="w-full p-3 border dark:border-dark-tertiary dark:bg-black dark:text-white rounded-xl" ${type === 'mock' ? 'required' : ''}>
                                    <option value="">Select Chapter (Optional)</option>
                                </select>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-bold mb-1 dark:text-white">Duration (Minutes)</label>
                                <input id="nd" type="number" class="w-full p-3 border dark:border-dark-tertiary dark:bg-black dark:text-white rounded-xl" placeholder="e.g., 60" required>
                            </div>
                            <div>
                                <label class="block text-sm font-bold mb-1 dark:text-white">Total Marks</label>
                                <input id="nm" type="number" class="w-full p-3 border dark:border-dark-tertiary dark:bg-black dark:text-white rounded-xl" placeholder="e.g., 100" required>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-bold mb-1 dark:text-white">Negative Mark</label>
                                <select id="nneg" class="w-full p-3 border dark:border-dark-tertiary dark:bg-black dark:text-white rounded-xl">
                                    <option value="0" selected>0 (No Negative)</option>
                                    <option value="0.25">0.25 (¼ Mark)</option>
                                    <option value="0.50">0.50 (½ Mark)</option>
                                </select>
                            </div>
                            <div class="flex items-center text-xs text-slate-500 bg-slate-50 dark:bg-dark-tertiary dark:text-slate-400 p-2 rounded border dark:border-dark-tertiary">Type: ${type.toUpperCase()}</div>
                        </div>
                        
                        ${isLive ? `
                        <div class="p-3 bg-indigo-50 dark:bg-indigo-900 rounded-xl border border-indigo-100 dark:border-indigo-800 space-y-3">
                            <div>
                                <label class="text-sm font-bold text-indigo-800 dark:text-indigo-300">Start Time</label>
                                <input id="nst" type="datetime-local" class="w-full p-2 border dark:border-dark-tertiary dark:bg-black dark:text-white rounded-lg text-sm">
                            </div>
                            <div>
                                <label class="text-sm font-bold text-indigo-800 dark:text-indigo-300">End Time</label>
                                <input id="net" type="datetime-local" class="w-full p-2 border dark:border-dark-tertiary dark:bg-black dark:text-white rounded-lg text-sm">
                            </div>
                            <div class="auto-publish-container">
                                <input type="checkbox" id="nautopub" checked>
                                <label for="nautopub" class="text-sm font-bold text-slate-700 dark:text-slate-300">
                                    Auto Publish Result when exam ends
                                </label>
                            </div>
                        </div>` : ''}
                        
                        <!-- Question Mode Switch -->
                        <div class="flex items-center justify-between mb-3">
                            <label class="text-sm font-bold text-slate-700 dark:text-white">Question Mode:</label>
                            <div class="flex items-center gap-2">
                                <button id="mode-manual" onclick="Teacher.switchQuestionMode('manual')" class="px-3 py-1.5 text-sm font-bold bg-indigo-600 text-white rounded-lg">Manual</button>
                                <button id="mode-json" onclick="Teacher.switchQuestionMode('json')" class="px-3 py-1.5 text-sm font-bold bg-slate-200 dark:bg-dark-tertiary text-slate-600 dark:text-slate-300 rounded-lg">JSON</button>
                            </div>
                        </div>
                        
                        <!-- Questions List -->
                        <div id="questions-list" class="space-y-3 mb-6">
                            <h3 class="font-bold text-lg mb-2 dark:text-white">Questions List (${Teacher.questions.length})</h3>
                            <div class="text-center p-4 text-slate-400">No questions added yet</div>
                        </div>
                        
                        <!-- Manual Question Input -->
                        <div id="manual-questions-container" class="space-y-4">
                            <!-- Current Question Form -->
                            <div class="question-box dark:bg-black dark:border-dark-tertiary">
                                <h3 class="font-bold text-lg mb-3 dark:text-white" id="question-form-title">Add New Question</h3>
                                
                                <!-- Question Text Field with Math Preview -->
                                <div class="question-field-container mb-3">
                                    <label class="block text-sm font-bold mb-1 dark:text-white">Question Text</label>
                                    <textarea id="textarea-question" class="w-full p-3 border dark:border-dark-tertiary dark:bg-black dark:text-white rounded-xl question-textarea auto-resize" rows="3" placeholder="Enter question text..." oninput="autoResizeTextarea(this)"></textarea>
                                    <button type="button" class="math-preview-btn" data-target="textarea-question">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="block text-sm font-bold mb-2 dark:text-white">Options:</label>
                                    <div class="space-y-2">
                                        ${['A', 'B', 'C', 'D'].map((letter, index) => `
                                            <div class="flex items-center gap-2">
                                                <span class="font-bold w-6 dark:text-white">${letter}.</span>
                                                <div class="question-field-container flex-1">
                                                    <textarea id="option-${letter.toLowerCase()}" class="w-full p-2 border dark:border-dark-tertiary dark:bg-black dark:text-white rounded option-textarea auto-resize" rows="2" placeholder="Option ${letter}" oninput="autoResizeTextarea(this)"></textarea>
                                                    <button type="button" class="math-preview-btn" data-target="option-${letter.toLowerCase()}">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="block text-sm font-bold mb-1 dark:text-white">Correct Answer</label>
                                    <select id="correct-answer" class="w-full p-2 border dark:border-dark-tertiary dark:bg-black dark:text-white rounded">
                                        <option value="">Select Correct Answer</option>
                                        <option value="0">A</option>
                                        <option value="1">B</option>
                                        <option value="2">C</option>
                                        <option value="3">D</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="block text-sm font-bold mb-1 dark:text-white">Explanation (Optional)</label>
                                    <div class="question-field-container">
                                        <textarea id="explanation" class="w-full p-2 border dark:border-dark-tertiary dark:bg-black dark:text-white rounded explanation-textarea auto-resize" rows="2" placeholder="Add explanation for this question (optional)..." oninput="autoResizeTextarea(this)"></textarea>
                                        <button type="button" class="math-preview-btn" data-target="explanation">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="block text-sm font-bold mb-1 dark:text-white">Previous Year (Optional)</label>
                                    <div class="flex items-center gap-2">
                                        <input type="text" id="previous-year" class="flex-1 p-2 border dark:border-dark-tertiary dark:bg-black dark:text-white rounded" placeholder="e.g., 2020 HSC">
                                        <div class="flex items-center gap-2">
                                            <input type="checkbox" id="show-previous-year" class="rounded">
                                            <label for="show-previous-year" class="text-sm font-medium text-slate-700 dark:text-slate-300">
                                                প্রশ্নে দেখান
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <button onclick="Teacher.addQuestionToList()" id="add-question-btn" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 transition">
                                    <i class="fas fa-plus mr-2"></i> Add Question to List
                                </button>
                            </div>
                        </div>
                        
                        <!-- JSON Textarea -->
                        <div id="json-container" class="hidden">
                            <div class="json-actions">
                                <button onclick="Teacher.copyJson()" class="bg-indigo-600 text-white px-3 py-2 rounded text-sm font-bold">
                                    <i class="fas fa-copy mr-1"></i> Copy JSON
                                </button>
                                <button onclick="Teacher.clearJson()" class="bg-red-600 text-white px-3 py-2 rounded text-sm font-bold">
                                    <i class="fas fa-trash mr-1"></i> Clear JSON
                                </button>
                            </div>
                            <textarea id="nq" class="w-full h-40 p-3 border dark:border-dark-tertiary dark:bg-black dark:text-white rounded-xl font-mono text-xs auto-resize" placeholder='Paste JSON Question Array here...' oninput="autoResizeTextarea(this)"></textarea>
                        </div>
                        
                        ${isLive ? `
                        <div class="flex gap-2 mt-4">
                            <button onclick="Teacher.createExam(false)" class="flex-1 bg-slate-800 dark:bg-dark-tertiary text-white py-4 rounded-xl font-bold shadow hover:bg-slate-900 dark:hover:bg-black transition">Publish Now</button>
                            <button onclick="Teacher.createExam(true)" class="flex-1 bg-amber-500 text-white py-4 rounded-xl font-bold shadow hover:bg-amber-600 transition">Save to Folder (Draft)</button>
                        </div>` : `
                        <button onclick="Teacher.createExam(false)" class="bg-slate-800 dark:bg-dark-tertiary text-white w-full py-4 rounded-xl font-bold shadow hover:bg-slate-900 dark:hover:bg-black transition">Publish ${isLive ? 'Live Exam' : 'Practice'}</button>`}
                    </div>
                </div>`;
                
                Teacher.switchQuestionMode('manual');
                
                // Auto-resize textareas on load
                setTimeout(() => {
                    document.querySelectorAll('.auto-resize').forEach(textarea => {
                        autoResizeTextarea(textarea);
                    });
                }, 100);
                
                // Populate chapters based on selected subject
                const subjectSelect = document.getElementById('nsub');
                const chapterSelect = document.getElementById('nchap');
                
                subjectSelect.addEventListener('change', function() {
                    const subject = this.value;
                    
                    // Clear chapter dropdown
                    chapterSelect.innerHTML = '<option value="">Select Chapter (Optional)</option>';
                    
                    if (subject) {
                        // Get chapters from folder structure
                        const subjectFolder = window.folderStructure[type].find(s => s.name === subject);
                        const chaptersFromFolders = subjectFolder ? subjectFolder.children.map(c => c.name) : [];
                        
                        // Also get chapters from existing exams
                        const chaptersFromExams = [...new Set(Object.values(window.ExamCache)
                            .filter(e => e.type === type && e.subject === subject && e.chapter)
                            .map(e => e.chapter))];
                        
                        // Combine and remove duplicates
                        const allChapters = [...new Set([...chaptersFromFolders, ...chaptersFromExams])];
                        
                        allChapters.forEach(chapter => {
                            const option = document.createElement('option');
                            option.value = chapter;
                            option.textContent = chapter;
                            chapterSelect.appendChild(option);
                        });
                    }
                });
                
                // If there's a saved subject from localStorage, select it
                const savedSubject = localStorage.getItem(`lastSubject_${type}`);
                if (savedSubject && subjects.includes(savedSubject)) {
                    subjectSelect.value = savedSubject;
                    subjectSelect.dispatchEvent(new Event('change'));
                }
            },
            
            switchQuestionMode: (mode) => {
                window.questionMode = mode;
                if(mode === 'manual') {
                    document.getElementById('manual-questions-container').classList.remove('hidden');
                    document.getElementById('json-container').classList.add('hidden');
                    document.getElementById('mode-manual').className = "px-3 py-1.5 text-sm font-bold bg-indigo-600 text-white rounded-lg";
                    document.getElementById('mode-json').className = "px-3 py-1.5 text-sm font-bold bg-slate-200 dark:bg-dark-tertiary text-slate-600 dark:text-slate-300 rounded-lg";
                    
                    // JSON থেকে Manual এ কনভার্ট
                    try {
                        const jsonText = document.getElementById('nq').value;
                        if(jsonText.trim()) {
                            Teacher.questions = JSON.parse(jsonText);
                            Teacher.updateQuestionsList();
                        }
                    } catch(e) {
                        console.error("JSON parse error:", e);
                    }
                } else {
                    document.getElementById('manual-questions-container').classList.add('hidden');
                    document.getElementById('json-container').classList.remove('hidden');
                    document.getElementById('mode-manual').className = "px-3 py-1.5 text-sm font-bold bg-slate-200 dark:bg-dark-tertiary text-slate-600 dark:text-slate-300 rounded-lg";
                    document.getElementById('mode-json').className = "px-3 py-1.5 text-sm font-bold bg-indigo-600 text-white rounded-lg";
                    
                    // Manual থেকে JSON এ কনভার্ট
                    if(Teacher.questions.length > 0) {
                        document.getElementById('nq').value = JSON.stringify(Teacher.questions, null, 2);
                        autoResizeTextarea(document.getElementById('nq'));
                    }
                }
            },
            
            copyJson: function() {
                const jsonTextarea = document.getElementById('nq');
                jsonTextarea.select();
                document.execCommand('copy');
                Swal.fire('Copied!', 'JSON copied to clipboard', 'success');
            },
            
            clearJson: function() {
                document.getElementById('nq').value = '';
                autoResizeTextarea(document.getElementById('nq'));
            },
            
            addQuestionToList: () => {
                const questionText = document.getElementById('textarea-question').value;
                const optionA = document.getElementById('option-a').value;
                const optionB = document.getElementById('option-b').value;
                const optionC = document.getElementById('option-c').value;
                const optionD = document.getElementById('option-d').value;
                const correctAnswer = document.getElementById('correct-answer').value;
                const explanation = document.getElementById('explanation').value;
                const previousYear = document.getElementById('previous-year').value;
                const showPreviousYear = document.getElementById('show-previous-year').checked;
                
                if(!questionText || !optionA || !optionB || !optionC || !optionD || correctAnswer === '') {
                    Swal.fire('Error', 'Please fill all required fields', 'error');
                    return;
                }
                
                const question = {
                    q: questionText,
                    options: [optionA, optionB, optionC, optionD],
                    correct: parseInt(correctAnswer),
                    expl: explanation || "",
                    previousYear: previousYear || "",
                    showPreviousYearInQuestion: showPreviousYear
                };
                
                if (Teacher.currentQuestion !== null) {
                    // Update existing question
                    Teacher.questions[Teacher.currentQuestion] = question;
                    Teacher.currentQuestion = null;
                    
                    // Change button back to "Add Question"
                    document.getElementById('add-question-btn').innerHTML = '<i class="fas fa-plus mr-2"></i> Add Question to List';
                    document.getElementById('add-question-btn').onclick = () => Teacher.addQuestionToList();
                    document.getElementById('question-form-title').innerText = 'Add New Question';
                } else {
                    // Add new question
                    Teacher.questions.push(question);
                }
                
                // Clear form
                document.getElementById('textarea-question').value = '';
                document.getElementById('option-a').value = '';
                document.getElementById('option-b').value = '';
                document.getElementById('option-c').value = '';
                document.getElementById('option-d').value = '';
                document.getElementById('correct-answer').value = '';
                document.getElementById('explanation').value = '';
                document.getElementById('previous-year').value = '';
                document.getElementById('show-previous-year').checked = false;
                
                // Reset textarea heights
                document.querySelectorAll('.auto-resize').forEach(textarea => {
                    textarea.style.height = 'auto';
                });
                
                // Update list
                Teacher.updateQuestionsList();
                
                // Hide previews
                document.querySelectorAll('.math-render-overlay').forEach(overlay => {
                    overlay.style.display = 'none';
                });
                document.querySelectorAll('.question-textarea, .option-textarea, .explanation-textarea').forEach(textarea => {
                    textarea.classList.remove('math-mode');
                });
                document.querySelectorAll('.math-preview-btn').forEach(btn => {
                    btn.innerHTML = '<i class="fas fa-eye"></i>';
                });
                
                // Scroll to top of form
                document.getElementById('textarea-question').focus();
            },
            
            updateQuestionsList: () => {
                const questionsList = document.getElementById('questions-list');
                if (!questionsList) return;
                
                if (Teacher.questions.length === 0) {
                    questionsList.innerHTML = `
                        <h3 class="font-bold text-lg mb-2 dark:text-white">Questions List (${Teacher.questions.length})</h3>
                        <div class="text-center p-4 text-slate-400">No questions added yet</div>
                    `;
                    return;
                }
                
                questionsList.innerHTML = `
                    <h3 class="font-bold text-lg mb-2 dark:text-white">Questions List (${Teacher.questions.length})</h3>
                    ${Teacher.questions.map((q, index) => `
                        <div class="question-list-item dark:bg-black dark:border-dark-tertiary">
                            <div class="flex justify-between items-start mb-2">
                                <div class="question-text truncate dark:text-white">${index + 1}. ${q.q.substring(0, 100)}${q.q.length > 100 ? '...' : ''}</div>
                                <div class="flex gap-2">
                                    <button onclick="Teacher.editQuestion(${index})" class="text-blue-600 hover:text-blue-800 dark:text-blue-400">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="Teacher.deleteQuestion(${index})" class="text-red-600 hover:text-red-800 dark:text-red-400">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="options dark:text-slate-300">
                                A. ${q.options[0].substring(0, 50)}${q.options[0].length > 50 ? '...' : ''}<br>
                                B. ${q.options[1].substring(0, 50)}${q.options[1].length > 50 ? '...' : ''}<br>
                                C. ${q.options[2].substring(0, 50)}${q.options[2].length > 50 ? '...' : ''}<br>
                                D. ${q.options[3].substring(0, 50)}${q.options[3].length > 50 ? '...' : ''}
                            </div>
                            <div class="correct-answer dark:text-emerald-400">
                                Correct: ${String.fromCharCode(65 + q.correct)}
                            </div>
                        </div>
                    `).join('')}
                `;
            },
            
            editQuestion: (index) => {
                const q = Teacher.questions[index];
                
                document.getElementById('textarea-question').value = q.q;
                document.getElementById('option-a').value = q.options[0];
                document.getElementById('option-b').value = q.options[1];
                document.getElementById('option-c').value = q.options[2];
                document.getElementById('option-d').value = q.options[3];
                document.getElementById('correct-answer').value = q.correct;
                document.getElementById('explanation').value = q.expl || '';
                document.getElementById('previous-year').value = q.previousYear || '';
                document.getElementById('show-previous-year').checked = q.showPreviousYearInQuestion || false;
                
                Teacher.currentQuestion = index;
                
                // Change button text and title
                document.getElementById('add-question-btn').innerHTML = '<i class="fas fa-save mr-2"></i> Update Question';
                document.getElementById('add-question-btn').onclick = () => Teacher.addQuestionToList();
                document.getElementById('question-form-title').innerText = `Edit Question ${index + 1}`;
                
                // Scroll to top of form
                document.getElementById('textarea-question').focus();
                window.scrollTo({
                    top: document.querySelector('.question-box').offsetTop - 20,
                    behavior: 'smooth'
                });
                
                // Auto-resize textareas
                setTimeout(() => {
                    document.querySelectorAll('.auto-resize').forEach(textarea => {
                        autoResizeTextarea(textarea);
                    });
                }, 50);
            },
            
            deleteQuestion: (index) => {
                Swal.fire({
                    title: 'Delete Question?',
                    text: "This action cannot be undone!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    confirmButtonText: 'Delete'
                }).then((result) => {
                    if (result.isConfirmed) {
                        Teacher.questions.splice(index, 1);
                        Teacher.updateQuestionsList();
                        
                        // If we deleted the question being edited, reset form
                        if (Teacher.currentQuestion === index) {
                            Teacher.currentQuestion = null;
                            document.getElementById('add-question-btn').innerHTML = '<i class="fas fa-plus mr-2"></i> Add Question to List';
                            document.getElementById('question-form-title').innerText = 'Add New Question';
                        }
                    }
                });
            },
            
            createExam: async (isDraft = false) => {
                // পাবলিশ করার আগে কনফার্মেশন
                const confirmText = isDraft ? 'Save to Folder as Draft' : 'Publish Exam';
                const confirmMessage = isDraft ? 
                    'আপনি কি এই পরীক্ষাটি ড্রাফট হিসেবে ফোল্ডারে সেভ করতে চান?' : 
                    'আপনি কি এই পরীক্ষাটি পাবলিশ করতে চান?';
                
                const confirm = await Swal.fire({
                    title: confirmText,
                    text: confirmMessage,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: `হ্যাঁ, ${confirmText}`
                });

                if(!confirm.isConfirmed) return;
                
                try {
                    const t = document.getElementById('nt').value;
                    const type = document.getElementById('nty').value;
                    const d = document.getElementById('nd').value;
                    const m = document.getElementById('nm').value;
                    const neg = document.getElementById('nneg').value;
                    const sub = document.getElementById('nsub').value;
                    const chap = document.getElementById('nchap').value;
                    const autoPublish = document.getElementById('nautopub') ? document.getElementById('nautopub').checked : false;
                    
                    if(!t || !d || !m) throw new Error("Title, Duration, and Marks are required");
                    
                    let questions = '';
                    
                    if(window.questionMode === 'manual') {
                        if(Teacher.questions.length === 0) {
                            throw new Error("Please add at least one question");
                        }
                        questions = JSON.stringify(Teacher.questions);
                    } else {
                        questions = document.getElementById('nq').value;
                        JSON.parse(questions);
                    }
                    
                    let st = null, et = null;
                    if(type === 'live') {
                        st = document.getElementById('nst').value;
                        et = document.getElementById('net').value;
                        if(!st || !et) throw new Error("Start and End time required for Live exams");
                    }
                    
                    const examData = {
                        title: t,
                        type: type,
                        subject: sub || '',
                        chapter: chap || '',
                        duration: parseInt(d),
                        totalMarks: parseInt(m),
                        negativeMark: parseFloat(neg),
                        questions: questions,
                        startTime: st,
                        endTime: et,
                        autoPublish: autoPublish,
                        isDraft: isDraft,
                        createdBy: AppState.currentUser.id,
                        teacherCode: AppState.currentUser.teacherCode,
                        resultPublished: isDraft ? false : (type === 'mock'),
                        groupId: AppState.selectedGroup.id,
                        groupName: AppState.selectedGroup.name,
                        createdAt: new Date()
                    };
                    
                    const docRef = await addDoc(collection(db, "exams"), examData);
                    
                    // Save selected subject to localStorage
                    if (sub) {
                        localStorage.setItem(`lastSubject_${type}`, sub);
                    }
                    
                    // Add to folder structure
                    if (sub && chap) {
                        const folderType = type === 'live' ? 'live' : 'mock';
                        
                        // Find or create subject in folder structure
                        let subject = window.folderStructure[folderType].find(s => s.name === sub);
                        if (!subject) {
                            subject = {
                                id: `subject-${sub}-${folderType}-${Date.now()}`,
                                name: sub,
                                type: 'subject',
                                examType: folderType,
                                children: [],
                                exams: []
                            };
                            window.folderStructure[folderType].push(subject);
                        }
                        
                        // Find or create chapter
                        let chapter = subject.children.find(c => c.name === chap);
                        if (!chapter) {
                            chapter = {
                                id: `chapter-${chap}-${subject.id}-${Date.now()}`,
                                name: chap,
                                type: 'chapter',
                                parent: subject.id,
                                children: [],
                                exams: []
                            };
                            subject.children.push(chapter);
                        }
                        
                        // Add exam to chapter
                        chapter.exams.push({
                            id: docRef.id,
                            name: t,
                            type: 'exam',
                            examType: type,
                            parent: chapter.id,
                            examData: examData
                        });
                    } else {
                        // Uncategorized লিস্টে পুশ করা নিশ্চিত করা
                        if(!window.folderStructure.uncategorized) window.folderStructure.uncategorized = [];
                        window.folderStructure.uncategorized.push({
                            id: docRef.id,
                            name: t,
                            examType: type,
                            examData: examData
                        });
                    }
                    
                    // Save folder structure to Firebase
                    await saveFolderStructureToFirebase();
                    
                    // Reset questions array
                    Teacher.questions = [];
                    Teacher.currentQuestion = null;
                    
                    // Hide floating math button
                    document.getElementById('floating-math-btn').classList.add('hidden');
                    document.getElementById('math-symbols-panel').classList.remove('show');
                    
                    // Show success message
                    Swal.fire('Success', isDraft ? 'Exam saved to folder as draft' : 'Exam published successfully', 'success').then(() => {
                        if (isDraft) {
                            Teacher.foldersView();
                        } else {
                            Teacher.createView();
                        }
                    });
                } catch(e) {
                    Swal.fire('Error', e.message, 'error');
                }
            },

            foldersView: () => {
                // Check if group is selected
                if (!AppState.selectedGroup) {
                    Teacher.selectGroupView('folders');
                    return;
                }
                
                // Hide floating math button
                document.getElementById('floating-math-btn').classList.add('hidden');
                document.getElementById('math-symbols-panel').classList.remove('show');
                
                // ফোল্ডার ভিউতে ঢুকলে ফোল্ডার স্ট্রাকচার রিফ্রেশ করবে
                const refreshFolderData = async () => {
                    try {
                        const folderDocRef = doc(db, "folderStructures", `${AppState.currentUser.id}_${AppState.selectedGroup.id}`);
                        const docSnap = await getDoc(folderDocRef);
                        if (docSnap.exists()) {
                            window.folderStructure = docSnap.data();
                        } else {
                            window.folderStructure = { live: [], mock: [], uncategorized: [] };
                        }
                        
                        document.getElementById('app-container').innerHTML = `
                        <div class="p-5 pb-24">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-xl font-bold font-en text-slate-800 dark:text-white">Folder Management</h2>
                                <div class="text-xs bg-indigo-100 dark:bg-indigo-900 text-indigo-600 dark:text-indigo-300 px-3 py-1.5 rounded-lg">
                                    <i class="fas fa-users mr-1"></i> ${AppState.selectedGroup.name}
                                </div>
                            </div>
                            
                            <!-- Folder Actions -->
                            <div class="flex flex-wrap gap-3 mb-6">
                                <button onclick="Teacher.createSubject('live')" class="bg-red-600 text-white px-4 py-2 rounded-lg font-bold text-sm flex items-center gap-2">
                                    <i class="fas fa-plus"></i> Live Subject
                                </button>
                                <button onclick="Teacher.createSubject('mock')" class="bg-emerald-600 text-white px-4 py-2 rounded-lg font-bold text-sm flex items-center gap-2">
                                    <i class="fas fa-plus"></i> Mock Subject
                                </button>
                            </div>
                            
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <!-- Live Exams Folder -->
                                <div class="bg-white dark:bg-dark-secondary p-5 rounded-2xl shadow-sm border dark:border-dark-tertiary">
                                    <div class="flex items-center justify-between mb-4">
                                        <h3 class="font-bold text-lg flex items-center gap-2 dark:text-white">
                                            <i class="fas fa-broadcast-tower live-icon"></i>
                                            Live Exams
                                        </h3>
                                        <span class="text-xs bg-red-100 dark:bg-red-900 text-red-600 dark:text-red-300 px-2 py-1 rounded font-bold">
                                            ${window.folderStructure.live.reduce((acc, s) => acc + s.exams.length, 0)} Exams
                                        </span>
                                    </div>
                                    <div id="live-folder-tree" class="folder-tree space-y-1"></div>
                                </div>
                                
                                <!-- Mock Exams Folder -->
                                <div class="bg-white dark:bg-dark-secondary p-5 rounded-2xl shadow-sm border dark:border-dark-tertiary">
                                    <div class="flex items-center justify-between mb-4">
                                        <h3 class="font-bold text-lg flex items-center gap-2 dark:text-white">
                                            <i class="fas fa-book-reader mock-icon"></i>
                                            Mock Exams
                                        </h3>
                                        <span class="text-xs bg-emerald-100 dark:bg-emerald-900 text-emerald-600 dark:text-emerald-300 px-2 py-1 rounded font-bold">
                                            ${window.folderStructure.mock.reduce((acc, s) => acc + s.exams.length, 0)} Exams
                                        </span>
                                    </div>
                                    <div id="mock-folder-tree" class="folder-tree space-y-1"></div>
                                </div>
                            </div>
                            
                            <!-- Uncategorized Exams -->
                            <div class="mt-6 bg-white dark:bg-dark-secondary p-5 rounded-2xl shadow-sm border dark:border-dark-tertiary">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="font-bold text-lg flex items-center gap-2 dark:text-white">
                                        <i class="fas fa-question-circle text-slate-400"></i>
                                        Uncategorized Exams
                                    </h3>
                                    <span class="text-xs bg-slate-100 dark:bg-dark-tertiary text-slate-600 dark:text-slate-400 px-2 py-1 rounded font-bold">
                                        ${window.folderStructure.uncategorized.length} Exams
                                    </span>
                                </div>
                                <div id="uncategorized-exams" class="space-y-2"></div>
                            </div>
                        </div>`;
                        
                        Teacher.renderFolderTree();
                        Teacher.renderUncategorizedExams();
                        
                        // রিয়েল টাইম লিসেনার সেট আপ করবে
                        initRealTimeSync();
                    } catch (error) {
                        console.error('Error refreshing folder data:', error);
                    }
                };
                
                refreshFolderData();
            },
            
            renderFolderTree: () => {
                // Render Live Exams
                const liveTree = document.getElementById('live-folder-tree');
                if (liveTree) {
                    liveTree.innerHTML = Teacher.renderFolderSection(window.folderStructure.live, 'live');
                }
                
                // Render Mock Exams
                const mockTree = document.getElementById('mock-folder-tree');
                if (mockTree) {
                    mockTree.innerHTML = Teacher.renderFolderSection(window.folderStructure.mock, 'mock');
                }
                
                // Add event listeners for folder toggles
                document.querySelectorAll('.folder-toggle-btn').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const id = this.dataset.folderId;
                        Teacher.toggleFolder(id);
                    });
                });
            },
            
            renderFolderSection: (subjects, type) => {
                if (subjects.length === 0) {
                    return `<div class="text-center p-4 text-slate-400">
                        <i class="fas fa-folder-open text-2xl mb-2 opacity-30"></i>
                        <p>No ${type} subjects yet</p>
                    </div>`;
                }
                
                return subjects.map(subject => {
                    const subjectId = `subject-${subject.id}`;
                    
                    return `
                    <div class="folder-item p-3 rounded-lg border border-slate-100 dark:border-dark-tertiary mb-2 dark:bg-black">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-2 flex-1">
                                <i class="fas fa-folder folder-icon"></i>
                                <span class="font-bold dark:text-white">${subject.name}</span>
                                <span class="text-xs bg-slate-100 dark:bg-dark-tertiary text-slate-600 dark:text-slate-400 px-2 py-1 rounded">
                                    ${subject.children.length} Chapters
                                </span>
                            </div>
                            <div class="flex items-center gap-1">
                                ${subject.children.length > 0 ? `
                                <button data-folder-id="${subjectId}" class="folder-toggle-btn text-slate-400 hover:text-slate-600 p-1">
                                    <i class="fas fa-chevron-down" id="icon-${subjectId}"></i>
                                </button>
                                ` : ''}
                                <div class="three-dot-menu relative">
                                    <button class="three-dot-btn" onclick="event.stopPropagation(); Teacher.toggleThreeDotMenu('subject-${subject.id}')">
                                        <i class="fas fa-ellipsis-v text-slate-400"></i>
                                    </button>
                                    <div class="dot-menu-dropdown dark:bg-dark-secondary dark:border-dark-tertiary" id="menu-subject-${subject.id}">
                                        <div class="menu-item add-chapter dark:text-emerald-400" onclick="Teacher.addChapterToSubject('${subject.id}', '${type}')">
                                            <i class="fas fa-plus-circle"></i>
                                            Add Chapter
                                        </div>
                                        <div class="menu-item rename dark:text-purple-400" onclick="Teacher.renameItem('subject', '${subject.id}', '${subject.name}')">
                                            <i class="fas fa-pencil-alt"></i>
                                            Rename
                                        </div>
                                        <div class="menu-item delete dark:text-red-400" onclick="Teacher.deleteSubject('${subject.id}', '${type}')">
                                            <i class="fas fa-trash"></i>
                                            Delete
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        ${subject.children.length > 0 ? `
                        <div class="folder-children mt-2 hidden" id="children-${subjectId}">
                            ${subject.children.map(chapter => {
                                const chapterId = `chapter-${chapter.id}`;
                                const hasExams = chapter.exams.length > 0;
                                
                                return `
                                <div class="ml-4 p-3 border-l-2 border-slate-200 dark:border-dark-tertiary">
                                    <div class="flex justify-between items-center mb-2">
                                        <div class="flex items-center gap-2">
                                            <i class="fas fa-folder-open text-slate-400"></i>
                                            <span class="font-medium dark:text-white">${chapter.name}</span>
                                            <span class="text-xs bg-slate-100 dark:bg-dark-tertiary text-slate-600 dark:text-slate-400 px-2 py-1 rounded">
                                                ${chapter.exams.length} Exams
                                            </span>
                                        </div>
                                        <div class="flex items-center gap-1">
                                            ${hasExams ? `
                                            <button data-folder-id="${chapterId}" class="folder-toggle-btn text-slate-400 hover:text-slate-600 p-1">
                                                <i class="fas fa-chevron-down" id="icon-${chapterId}"></i>
                                            </button>
                                            ` : ''}
                                            <div class="three-dot-menu relative">
                                                <button class="three-dot-btn" onclick="event.stopPropagation(); Teacher.toggleThreeDotMenu('chapter-${chapter.id}')">
                                                    <i class="fas fa-ellipsis-v text-slate-400"></i>
                                                </button>
                                                <div class="dot-menu-dropdown dark:bg-dark-secondary dark:border-dark-tertiary" id="menu-chapter-${chapter.id}">
                                                    <div class="menu-item add-exam dark:text-amber-400" onclick="Teacher.addExamToChapter('${subject.id}', '${chapter.id}', '${type}')">
                                                        <i class="fas fa-plus"></i>
                                                        Add Exam
                                                    </div>
                                                    <div class="menu-item rename dark:text-purple-400" onclick="Teacher.renameItem('chapter', '${chapter.id}', '${chapter.name}')">
                                                        <i class="fas fa-pencil-alt"></i>
                                                        Rename
                                                    </div>
                                                    <div class="menu-item delete dark:text-red-400" onclick="Teacher.deleteChapter('${chapter.id}', '${type}')">
                                                        <i class="fas fa-trash"></i>
                                                        Delete
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    ${hasExams ? `
                                    <div class="chapter-children ml-6 hidden" id="children-${chapterId}">
                                        ${chapter.exams.map(exam => {
                                            const examData = exam.examData || {};
                                            const isDraft = examData.isDraft;
                                            const isCancelled = examData.cancelled;
                                            const statusClass = isCancelled ? 'status-cancelled' : (isDraft ? 'status-draft' : (examData.resultPublished ? 'status-ended' : 'status-ongoing'));
                                            const statusText = isCancelled ? 'Cancelled' : (isDraft ? 'Draft' : (examData.resultPublished ? 'Ended' : 'Ongoing'));
                                            
                                            return `
                                            <div class="p-2 mt-2 bg-slate-50 dark:bg-black rounded border border-slate-100 dark:border-dark-tertiary">
                                                <div class="flex items-center justify-between">
                                                    <div class="flex items-center gap-2 flex-1">
                                                        <i class="fas fa-file-alt ${type === 'live' ? 'live-icon' : 'exam-icon'}"></i>
                                                        <div>
                                                            <div class="font-medium text-sm dark:text-white">${exam.name}</div>
                                                            <div class="flex items-center gap-2 mt-1">
                                                                <span class="text-xs ${statusClass} px-2 py-0.5 rounded">${statusText}</span>
                                                                <div class="text-xs text-slate-500 dark:text-slate-400">
                                                                    ${moment(examData.createdAt?.toDate()).format('DD MMM, YYYY') || 'Unknown date'}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="three-dot-menu relative">
                                                        <button class="three-dot-btn" onclick="event.stopPropagation(); Teacher.toggleThreeDotMenu('exam-${exam.id}')">
                                                            <i class="fas fa-ellipsis-v text-slate-400"></i>
                                                        </button>
                                                        <div class="dot-menu-dropdown dark:bg-dark-secondary dark:border-dark-tertiary" id="menu-exam-${exam.id}">
                                                            <div class="menu-item view dark:text-blue-400" onclick="Teacher.viewPaper('${exam.id}')">
                                                                <i class="fas fa-eye"></i>
                                                                View
                                                            </div>
                                                            <div class="menu-item edit dark:text-blue-400" onclick="Teacher.editExam('${exam.id}')">
                                                                <i class="fas fa-edit"></i>
                                                                Edit
                                                            </div>
                                                            ${type === 'live' && isDraft ? `
                                                            <div class="menu-item take-exam dark:text-emerald-400" onclick="Teacher.takeExamNow('${exam.id}')">
                                                                <i class="fas fa-play"></i>
                                                                Take Exam
                                                            </div>
                                                            ` : ''}
                                                            <div class="menu-item delete dark:text-red-400" onclick="Teacher.deleteExam('${exam.id}')">
                                                                <i class="fas fa-trash"></i>
                                                                Delete
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>`;
                                        }).join('')}
                                    </div>
                                    ` : ''}
                                </div>`;
                            }).join('')}
                        </div>
                        ` : ''}
                    </div>`;
                }).join('');
            },
            
            toggleFolder: (id) => {
                const children = document.getElementById(`children-${id}`);
                const icon = document.getElementById(`icon-${id}`);
                
                if (!children || !icon) return;
                
                if (children.classList.contains('hidden')) {
                    children.classList.remove('hidden');
                    icon.classList.remove('fa-chevron-down');
                    icon.classList.add('fa-chevron-up');
                } else {
                    children.classList.add('hidden');
                    icon.classList.remove('fa-chevron-up');
                    icon.classList.add('fa-chevron-down');
                }
            },
            
            renderUncategorizedExams: () => {
                const container = document.getElementById('uncategorized-exams');
                if (!container) return;
                
                if (window.folderStructure.uncategorized.length === 0) {
                    container.innerHTML = `<div class="text-center p-4 text-slate-400">
                        <i class="fas fa-check-circle text-2xl mb-2 opacity-30"></i>
                        <p>All exams are organized in folders</p>
                    </div>`;
                    return;
                }
                
                container.innerHTML = window.folderStructure.uncategorized.map(exam => {
                    const isCancelled = exam.examData.cancelled;
                    return `
                    <div class="p-3 bg-slate-50 dark:bg-black rounded-lg border border-slate-200 dark:border-dark-tertiary flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-file-alt ${exam.examType === 'live' ? 'live-icon' : 'exam-icon'}"></i>
                            <div>
                                <div class="font-bold text-sm dark:text-white">${exam.name}</div>
                                <div class="text-xs text-slate-500 dark:text-slate-400">
                                    ${exam.examData.type} • ${moment(exam.examData.createdAt.toDate()).format('DD MMM, YYYY')}
                                    ${exam.examData.isDraft ? '• <span class="text-amber-600">Draft</span>' : ''}
                                    ${isCancelled ? '• <span class="text-red-600">Cancelled</span>' : ''}
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <div class="three-dot-menu relative">
                                <button class="three-dot-btn" onclick="event.stopPropagation(); Teacher.toggleThreeDotMenu('uncategorized-${exam.id}')">
                                    <i class="fas fa-ellipsis-v text-slate-400"></i>
                                </button>
                                <div class="dot-menu-dropdown dark:bg-dark-secondary dark:border-dark-tertiary" id="menu-uncategorized-${exam.id}">
                                    <div class="menu-item view dark:text-blue-400" onclick="Teacher.viewPaper('${exam.id}')">
                                        <i class="fas fa-eye"></i>
                                        View
                                    </div>
                                    <div class="menu-item edit dark:text-blue-400" onclick="Teacher.editExam('${exam.id}')">
                                        <i class="fas fa-edit"></i>
                                        Edit
                                    </div>
                                    ${exam.examType === 'live' && exam.examData.isDraft ? `
                                    <div class="menu-item take-exam dark:text-emerald-400" onclick="Teacher.takeExamNow('${exam.id}')">
                                        <i class="fas fa-play"></i>
                                        Take Exam
                                    </div>
                                    ` : ''}
                                    <div class="menu-item delete dark:text-red-400" onclick="Teacher.deleteExam('${exam.id}')">
                                        <i class="fas fa-trash"></i>
                                        Delete
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `}).join('');
            },
            
            toggleThreeDotMenu: (menuId) => {
                // Close all other menus
                document.querySelectorAll('.dot-menu-dropdown').forEach(dropdown => {
                    if (dropdown.id !== `menu-${menuId}`) {
                        dropdown.classList.remove('show');
                    }
                });
                
                // Toggle current menu
                const menu = document.getElementById(`menu-${menuId}`);
                if (menu) {
                    menu.classList.toggle('show');
                }
            },
            
            createSubject: async (type) => {
                const { value: subjectName } = await Swal.fire({
                    title: `Create New ${type === 'live' ? 'Live' : 'Mock'} Subject`,
                    input: 'text',
                    inputLabel: 'Subject Name',
                    inputPlaceholder: 'Enter subject name',
                    showCancelButton: true,
                    inputValidator: (value) => {
                        if (!value) return 'You need to enter a subject name!';
                        if (window.folderStructure[type].some(s => s.name === value)) {
                            return 'Subject already exists!';
                        }
                    }
                });
                
                if (subjectName) {
                    const newSubject = {
                        id: `subject-${Date.now()}`,
                        name: subjectName,
                        type: 'subject',
                        examType: type,
                        children: [],
                        exams: []
                    };
                    
                    window.folderStructure[type].push(newSubject);
                    
                    // Save to Firebase
                    await saveFolderStructureToFirebase();
                    
                    Teacher.renderFolderTree();
                    
                    Swal.fire('Success', 'Subject created successfully', 'success');
                }
            },
            
            addChapterToSubject: async function(subjectId, type) {
                const subject = window.folderStructure[type].find(s => s.id === subjectId);
                if (!subject) return;
                
                const { value: chapterName } = await Swal.fire({
                    title: `Add Chapter to ${subject.name}`,
                    input: 'text',
                    inputLabel: 'Chapter Name',
                    inputPlaceholder: 'Enter chapter name',
                    showCancelButton: true,
                    inputValidator: (value) => {
                        if (!value) return 'You need to enter a chapter name!';
                        if (subject.children.some(c => c.name === value)) {
                            return 'Chapter already exists!';
                        }
                    }
                });
                
                if (chapterName) {
                    const newChapter = {
                        id: `chapter-${Date.now()}`,
                        name: chapterName,
                        type: 'chapter',
                        parent: subject.id,
                        children: [],
                        exams: []
                    };
                    
                    subject.children.push(newChapter);
                    
                    // Save to Firebase
                    await saveFolderStructureToFirebase();
                    
                    Teacher.renderFolderTree();
                    
                    Swal.fire('Success', 'Chapter added successfully', 'success');
                }
            },
            
            addExamToChapter: function(subjectId, chapterId, type) {
                const subject = window.folderStructure[type].find(s => s.id === subjectId);
                if (!subject) return;
                
                const chapter = subject.children.find(c => c.id === chapterId);
                if (!chapter) return;
                
                // Exam তৈরির ফর্মে redirect করুন
                Teacher.renderForm(type);
                
                // Auto-fill subject and chapter
                setTimeout(() => {
                    document.getElementById('nsub').value = subject.name;
                    document.getElementById('nsub').dispatchEvent(new Event('change'));
                    
                    setTimeout(() => {
                        document.getElementById('nchap').value = chapter.name;
                    }, 100);
                }, 500);
            },
            
            renameItem: async function(itemType, itemId, currentName) {
                const { value: newName } = await Swal.fire({
                    title: `Rename ${itemType}`,
                    input: 'text',
                    inputLabel: 'New Name',
                    inputValue: currentName,
                    showCancelButton: true,
                    inputValidator: (value) => {
                        if (!value) return 'You need to enter a new name!';
                    }
                });
                
                if (newName && newName !== currentName) {
                    // Find and rename in folder structure
                    let found = false;
                    
                    for (const type of ['live', 'mock']) {
                        if (itemType === 'subject') {
                            const subject = window.folderStructure[type].find(s => s.id === itemId);
                            if (subject) {
                                subject.name = newName;
                                found = true;
                                break;
                            }
                        } else if (itemType === 'chapter') {
                            for (const subject of window.folderStructure[type]) {
                                const chapter = subject.children.find(c => c.id === itemId);
                                if (chapter) {
                                    chapter.name = newName;
                                    found = true;
                                    break;
                                }
                            }
                            if (found) break;
                        }
                    }
                    
                    if (found) {
                        // Save to Firebase
                        await saveFolderStructureToFirebase();
                        
                        Swal.fire('Success', `${itemType} renamed to ${newName}`, 'success');
                        Teacher.foldersView();
                    }
                }
            },
            
            deleteSubject: async function(subjectId, type) {
                const result = await Swal.fire({
                    title: 'Delete Subject?',
                    text: "This will delete all chapters and exams under this subject!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    confirmButtonText: 'Delete Everything'
                });
                
                if (result.isConfirmed) {
                    const subjectIndex = window.folderStructure[type].findIndex(s => s.id === subjectId);
                    if (subjectIndex !== -1) {
                        window.folderStructure[type].splice(subjectIndex, 1);
                        
                        // Save to Firebase
                        await saveFolderStructureToFirebase();
                        
                        Teacher.renderFolderTree();
                        Swal.fire('Deleted!', 'Subject and all contents deleted.', 'success');
                    }
                }
            },
            
            deleteChapter: async function(chapterId, type) {
                const result = await Swal.fire({
                    title: 'Delete Chapter?',
                    text: "This will delete all exams under this chapter!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    confirmButtonText: 'Delete Everything'
                });
                
                if (result.isConfirmed) {
                    // Find and delete chapter
                    for (const subject of window.folderStructure[type]) {
                        const chapterIndex = subject.children.findIndex(c => c.id === chapterId);
                        if (chapterIndex !== -1) {
                            subject.children.splice(chapterIndex, 1);
                            
                            // Save to Firebase
                            await saveFolderStructureToFirebase();
                            
                            Teacher.renderFolderTree();
                            Swal.fire('Deleted!', 'Chapter and all exams deleted.', 'success');
                            break;
                        }
                    }
                }
            },
            
            editExam: async (examId) => {
                const exam = window.ExamCache[examId];
                if (!exam) return;
                
                // Reset questions array before editing
                Teacher.questions = [];
                Teacher.currentQuestion = null;
                
                // Redirect to create form with exam data
                Teacher.renderForm(exam.type);
                
                // Show floating math button
                document.getElementById('floating-math-btn').classList.remove('hidden');
                
                // Fill form with exam data after a short delay
                setTimeout(() => {
                    document.getElementById('nt').value = exam.title;
                    document.getElementById('nd').value = exam.duration;
                    document.getElementById('nm').value = exam.totalMarks;
                    document.getElementById('nneg').value = exam.negativeMark || 0;
                    document.getElementById('nsub').value = exam.subject || '';
                    
                    // Trigger change event for subject
                    document.getElementById('nsub').dispatchEvent(new Event('change'));
                    
                    setTimeout(() => {
                        document.getElementById('nchap').value = exam.chapter || '';
                    }, 100);
                    
                    if (exam.type === 'live') {
                        document.getElementById('nst').value = exam.startTime ? 
                            new Date(exam.startTime).toISOString().slice(0, 16) : '';
                        document.getElementById('net').value = exam.endTime ? 
                            new Date(exam.endTime).toISOString().slice(0, 16) : '';
                        if (document.getElementById('nautopub')) {
                            document.getElementById('nautopub').checked = exam.autoPublish || false;
                        }
                    }
                    
                    // Load questions
                    try {
                        Teacher.questions = JSON.parse(exam.questions);
                    } catch (e) {
                        Teacher.questions = [];
                    }
                    
                    Teacher.updateQuestionsList();
                    
                    // Change button action
                    const publishBtn = document.querySelector('button[onclick="Teacher.createExam()"]');
                    if (publishBtn) {
                        publishBtn.innerHTML = 'Update Exam';
                        publishBtn.onclick = async () => {
                            try {
                                const t = document.getElementById('nt').value;
                                const d = document.getElementById('nd').value;
                                const m = document.getElementById('nm').value;
                                const neg = document.getElementById('nneg').value;
                                const sub = document.getElementById('nsub').value;
                                const chap = document.getElementById('nchap').value;
                                const autoPublish = document.getElementById('nautopub') ? document.getElementById('nautopub').checked : false;
                                
                                let questions = '';
                                
                                if(window.questionMode === 'manual') {
                                    if(Teacher.questions.length === 0) {
                                        throw new Error("Please add at least one question");
                                    }
                                    questions = JSON.stringify(Teacher.questions);
                                } else {
                                    questions = document.getElementById('nq').value;
                                    JSON.parse(questions);
                                }
                                
                                const updateData = {
                                    title: t,
                                    subject: sub || '',
                                    chapter: chap || '',
                                    duration: parseInt(d),
                                    totalMarks: parseInt(m),
                                    negativeMark: parseFloat(neg),
                                    questions: questions
                                };
                                
                                if (exam.type === 'live') {
                                    updateData.startTime = document.getElementById('nst').value;
                                    updateData.endTime = document.getElementById('net').value;
                                    updateData.autoPublish = autoPublish;
                                    updateData.resultPublished = exam.resultPublished || autoPublish;
                                }
                                
                                await updateDoc(doc(db, "exams", examId), updateData);
                                
                                // Reset questions array
                                Teacher.questions = [];
                                Teacher.currentQuestion = null;
                                
                                // Hide floating math button
                                document.getElementById('floating-math-btn').classList.add('hidden');
                                document.getElementById('math-symbols-panel').classList.remove('show');
                                
                                Swal.fire('Success', 'Exam updated successfully', 'success').then(() => {
                                    Teacher.foldersView();
                                });
                            } catch(e) {
                                Swal.fire('Error', e.message, 'error');
                            }
                        };
                    }
                    
                    // Auto-resize textareas
                    setTimeout(() => {
                        document.querySelectorAll('.auto-resize').forEach(textarea => {
                            autoResizeTextarea(textarea);
                        });
                    }, 200);
                }, 500);
            },
            
            deleteExam: async (examId) => {
                const result = await Swal.fire({
                    title: 'Delete Exam?',
                    text: "This will delete the exam and all associated attempts!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    confirmButtonText: 'Delete Everything'
                });
                
                if (result.isConfirmed) {
                    try {
                        // Delete all attempts
                        const attemptsQuery = query(collection(db, "attempts"), where("examId", "==", examId));
                        const attemptsSnap = await getDocs(attemptsQuery);
                        
                        const deletePromises = [];
                        attemptsSnap.forEach((attemptDoc) => {
                            deletePromises.push(deleteDoc(doc(db, "attempts", attemptDoc.id)));
                        });
                        
                        await Promise.all(deletePromises);
                        
                        // Delete the exam
                        await deleteDoc(doc(db, "exams", examId));
                        
                        // Remove from folder structure
                        for (const type of ['live', 'mock']) {
                            for (const subject of window.folderStructure[type]) {
                                for (const chapter of subject.children) {
                                    const examIndex = chapter.exams.findIndex(e => e.id === examId);
                                    if (examIndex !== -1) {
                                        chapter.exams.splice(examIndex, 1);
                                        break;
                                    }
                                }
                            }
                        }
                        
                        // Remove from uncategorized
                        window.folderStructure.uncategorized = window.folderStructure.uncategorized.filter(e => e.id !== examId);
                        
                        // Save to Firebase
                        await saveFolderStructureToFirebase();
                        
                        Swal.fire('Deleted!', 'Exam and all attempts have been deleted.', 'success');
                        
                        // Refresh view
                        Teacher.renderFolderTree();
                        Teacher.renderUncategorizedExams();
                    } catch (error) {
                        Swal.fire('Error', 'Failed to delete: ' + error.message, 'error');
                    }
                }
            },
            
            takeExamNow: async (examId) => {
                const exam = window.ExamCache[examId];
                if (!exam) return;
                
                const { value: formValues } = await Swal.fire({
                    title: 'Schedule Exam',
                    html: '<input id="sw-st" type="datetime-local" class="swal2-input" placeholder="Start Time">' +
                          '<input id="sw-et" type="datetime-local" class="swal2-input" placeholder="End Time">',
                    showCancelButton: true,
                    confirmButtonText: 'Schedule & Publish',
                    preConfirm: () => {
                        return [
                            document.getElementById('sw-st').value,
                            document.getElementById('sw-et').value
                        ];
                    },
                    inputValidator: (values) => {
                        if (!values[0] || !values[1]) return 'Both start and end time are required!';
                        const startTime = new Date(values[0]);
                        const endTime = new Date(values[1]);
                        if (startTime >= endTime) return 'End time must be after start time!';
                        return null;
                    }
                });
                
                if (formValues) {
                    try {
                        const [startTime, endTime] = formValues;
                        
                        await updateDoc(doc(db, "exams", examId), {
                            startTime: startTime,
                            endTime: endTime,
                            isDraft: false,
                            resultPublished: false,
                            updatedAt: new Date()
                        });
                        
                        Swal.fire('Success', 'Exam is now scheduled and published!', 'success').then(() => {
                            Teacher.renderFolderTree();
                        });
                    } catch (e) {
                        Swal.fire('Error', e.message, 'error');
                    }
                }
            },
            
            viewPaper: async (examId) => {
                const exam = window.ExamCache[examId];
                if (!exam) return;
                
                const questions = JSON.parse(exam.questions);
                
                let html = `
                    <div class="bg-white dark:bg-dark-secondary p-5 rounded-2xl shadow-sm border dark:border-dark-tertiary max-w-3xl mx-auto">
                        <h3 class="text-xl font-bold mb-4 text-center dark:text-white">${exam.title}</h3>
                        <div class="text-sm text-slate-500 dark:text-slate-400 mb-6 text-center">
                            ${exam.subject ? exam.subject : ''} ${exam.chapter ? '• ' + exam.chapter : ''}
                            ${exam.isDraft ? '<span class="text-amber-600 ml-2">• Draft</span>' : ''}
                            ${exam.cancelled ? '<span class="text-red-600 ml-2">• Cancelled</span>' : ''}
                        </div>
                `;
                
                questions.forEach((q, index) => {
                    // Render question with math if needed
                    let questionHTML = q.q;
                    if (q.q.includes('\\') || q.q.includes('^') || q.q.includes('_')) {
                        questionHTML = `<span class="math-render">\\(${q.q}\\)</span>`;
                    }
                    
                    html += `
                        <div class="mb-6 p-4 border rounded-lg bg-slate-50 dark:bg-black dark:border-dark-tertiary">
                            <div class="flex justify-between items-start mb-3">
                                <span class="font-bold text-indigo-600 dark:text-indigo-400">Q${index + 1}</span>
                                ${q.previousYear && q.showPreviousYearInQuestion ? `<span class="text-xs bg-amber-100 dark:bg-amber-900 text-amber-800 dark:text-amber-300 px-2 py-1 rounded">${q.previousYear}</span>` : ''}
                            </div>
                            <p class="font-medium mb-3 dark:text-white math-render">${questionHTML}</p>
                            <div class="space-y-2 mb-3">
                                ${q.options.map((option, optIndex) => {
                                    const isCorrect = optIndex === q.correct;
                                    
                                    // Render option with math if needed
                                    let optionText = option;
                                    if (option.includes('\\') || option.includes('^') || option.includes('_')) {
                                        optionText = `<span class="math-render">\\(${option}\\)</span>`;
                                    }
                                    
                                    return `
                                        <div class="p-2 rounded border ${isCorrect ? 'bg-emerald-50 dark:bg-emerald-900 border-emerald-200 dark:border-emerald-700' : 'bg-white dark:bg-dark-secondary border-slate-200 dark:border-dark-tertiary'}">
                                            <span class="font-bold ${isCorrect ? 'text-emerald-600 dark:text-emerald-400' : 'text-slate-500 dark:text-slate-400'}">${String.fromCharCode(65 + optIndex)}.</span>
                                            <span class="${isCorrect ? 'font-bold text-emerald-700 dark:text-emerald-300' : 'dark:text-slate-300'}">${optionText}</span>
                                            ${isCorrect ? '<i class="fas fa-check float-right text-emerald-600 dark:text-emerald-400"></i>' : ''}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            ${q.previousYear && !q.showPreviousYearInQuestion ? `
                                <div class="mt-3 p-3 bg-amber-50 dark:bg-amber-900 rounded border border-amber-200 dark:border-amber-800">
                                    <span class="font-bold text-amber-700 dark:text-amber-300 text-sm">Previous Year:</span>
                                    <p class="text-sm mt-1 dark:text-amber-200">${q.previousYear}</p>
                                </div>
                            ` : ''}
                            ${q.expl && q.expl.trim() !== "" ? `
                                <div class="mt-3 p-3 bg-blue-50 dark:bg-blue-900 rounded border border-blue-200 dark:border-blue-800">
                                    <span class="font-bold text-blue-700 dark:text-blue-300 text-sm">Explanation:</span>
                                    <p class="text-sm mt-1 dark:text-blue-200">${q.expl}</p>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                
                html += `</div>`;
                
                document.getElementById('app-container').innerHTML = `
                    <div class="p-5 pb-20">
                        <button onclick="Teacher.foldersView()" class="mb-4 text-xs font-bold text-slate-500 dark:text-slate-400 flex items-center gap-1">
                            <i class="fas fa-arrow-left"></i> Back to Folders
                        </button>
                        ${html}
                    </div>
                `;
                
                MathJax.typesetPromise();
            },
            
            liveExamManagementView: () => {
                // Check if group is selected
                if (!AppState.selectedGroup) {
                    Teacher.selectGroupView('management');
                    return;
                }
                
                // Hide floating math button
                document.getElementById('floating-math-btn').classList.add('hidden');
                document.getElementById('math-symbols-panel').classList.remove('show');
                
                const c = document.getElementById('app-container');
                c.innerHTML = '<div class="p-10 text-center"><div class="loader mx-auto"></div><p class="text-xs text-slate-400 mt-2">Loading live exams...</p></div>';
                
                // Filter only live exams for the selected group that are not drafts, not cancelled, not published, and end time is in future
                const now = new Date();
                const exams = Object.values(window.ExamCache)
                    .filter(e => e.type === 'live' && 
                           e.groupId === AppState.selectedGroup.id && 
                           e.createdBy === AppState.currentUser.id &&
                           !e.isDraft &&
                           !e.cancelled &&
                           !e.resultPublished)
                    .filter(e => {
                        const endTime = e.endTime ? new Date(e.endTime) : null;
                        return endTime && endTime > now; // শুধু যে এক্সাম এখনো শেষ হয়নি
                    })
                    .sort((a,b) => new Date(a.startTime) - new Date(b.startTime));
                
                let html = '';
                if (exams.length === 0) {
                    html = '<div class="text-center p-10 text-slate-400">No ongoing live exams found</div>';
                } else {
                    html = exams.map(exam => {
                        const startTime = exam.startTime ? new Date(exam.startTime).toLocaleString() : 'Not set';
                        const endTime = exam.endTime ? new Date(exam.endTime).toLocaleString() : 'Not set';
                        const now = new Date();
                        const isOngoing = exam.startTime && exam.endTime && now >= new Date(exam.startTime) && now <= new Date(exam.endTime);
                        const status = isOngoing ? 'Ongoing' : 'Upcoming';
                        const statusClass = isOngoing ? 'status-ongoing' : 'status-upcoming';
                        
                        return `
                            <div class="live-exam-card">
                                <div class="flex justify-between items-start mb-3">
                                    <div>
                                        <h3 class="font-bold text-lg dark:text-white">${exam.title}</h3>
                                        <div class="flex items-center gap-2 mt-1">
                                            <span class="exam-status ${statusClass}">${status}</span>
                                            <span class="text-xs text-slate-500">${exam.subject || 'No Subject'} • ${exam.chapter || 'No Chapter'}</span>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-xs text-slate-500">Total Marks</div>
                                        <div class="font-bold text-indigo-600 dark:text-indigo-400">${exam.totalMarks}</div>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-2 mb-3">
                                    <div>
                                        <div class="text-xs text-slate-500">Start Time</div>
                                        <div class="text-sm font-medium dark:text-white">${startTime}</div>
                                    </div>
                                    <div>
                                        <div class="text-xs text-slate-500">End Time</div>
                                        <div class="text-sm font-medium dark:text-white">${endTime}</div>
                                    </div>
                                </div>
                                
                                <div class="exam-actions">
                                    <button onclick="Teacher.stopLiveExam('${exam.id}')" class="flex-1 bg-red-600 text-white px-4 py-2 rounded-lg font-bold text-sm flex items-center justify-center gap-2">
                                        <i class="fas fa-stop"></i>
                                        Cancel Exam
                                    </button>
                                    <button onclick="Teacher.publish('${exam.id}')" class="flex-1 bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold text-sm flex items-center justify-center gap-2">
                                        <i class="fas fa-bullhorn"></i>
                                        Publish Result
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
                
                c.innerHTML = `
                    <div class="p-5 pb-20">
                        <button onclick="Teacher.managementView()" class="mb-4 text-xs font-bold text-slate-500 dark:text-slate-400">
                            <i class="fas fa-arrow-left"></i> Back
                        </button>
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-bold font-en dark:text-white">Live Exam Management</h2>
                            <div class="text-xs bg-indigo-100 dark:bg-indigo-900 text-indigo-600 dark:text-indigo-300 px-3 py-1.5 rounded-lg">
                                <i class="fas fa-users mr-1"></i> ${AppState.selectedGroup.name}
                            </div>
                        </div>
                        <p class="text-sm text-slate-500 dark:text-slate-400 mb-6">Manage ongoing and upcoming live exams. Cancel exams immediately or publish results.</p>
                        ${html}
                    </div>
                `;
                
                // রিয়েল টাইম লিসেনার সেট আপ
                const examsQuery = query(
                    collection(db, "exams"),
                    where("type", "==", "live"),
                    where("groupId", "==", AppState.selectedGroup.id),
                    where("createdBy", "==", AppState.currentUser.id),
                    where("isDraft", "==", false),
                    where("cancelled", "==", false),
                    where("resultPublished", "==", false)
                );
                
                const unsub = onSnapshot(examsQuery, (snap) => {
                    const now = new Date();
                    const updatedExams = [];
                    
                    snap.forEach(doc => {
                        const exam = { id: doc.id, ...doc.data() };
                        const endTime = exam.endTime ? new Date(exam.endTime) : null;
                        if (endTime && endTime > now) {
                            updatedExams.push(exam);
                        }
                    });
                    
                    // Sort by start time
                    updatedExams.sort((a,b) => new Date(a.startTime) - new Date(b.startTime));
                    
                    // Update UI
                    if (updatedExams.length === 0) {
                        document.querySelector('.live-exam-card')?.remove();
                        const container = document.querySelector('#app-container');
                        if (container && container.innerHTML.includes('Live Exam Management')) {
                            const htmlSection = container.querySelector('.live-exam-card')?.parentNode;
                            if (htmlSection && updatedExams.length === 0) {
                                htmlSection.innerHTML = '<div class="text-center p-10 text-slate-400">No ongoing live exams found</div>';
                            }
                        }
                    }
                });
                
                window.unsubscribes.push(unsub);
            },
            
            stopLiveExam: async function(examId) {
                const exam = window.ExamCache[examId];
                if (!exam) return;
                
                const confirm = await Swal.fire({
                    title: 'Cancel Exam?',
                    text: "This will cancel the exam immediately! Students will not be able to see this exam anymore. Results will NOT be published.",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    confirmButtonText: 'Yes, cancel it now!'
                });

                if (confirm.isConfirmed) {
                    try {
                        // Mark as cancelled, do NOT publish results
                        await updateDoc(doc(db, "exams", examId), {
                            cancelled: true,
                            updatedAt: new Date()
                        });
                        
                        Swal.fire('Cancelled!', 'The exam has been cancelled. Results are NOT published.', 'success');
                        
                        // Immediately update the UI by removing the exam card
                        const examCard = document.querySelector(`button[onclick*="${examId}"]`)?.closest('.live-exam-card');
                        if (examCard) {
                            examCard.remove();
                        }
                        
                        // Check if no exams left
                        const remainingCards = document.querySelectorAll('.live-exam-card');
                        if (remainingCards.length === 0) {
                            const container = document.querySelector('#app-container');
                            if (container) {
                                const htmlSection = container.querySelector('.live-exam-card')?.parentNode;
                                if (htmlSection) {
                                    htmlSection.innerHTML = '<div class="text-center p-10 text-slate-400">No ongoing live exams found</div>';
                                }
                            }
                        }
                    } catch (error) {
                        Swal.fire('Error', 'Failed to cancel exam: ' + error.message, 'error');
                    }
                }
            },
            
            editLiveExam: function(examId) {
                // Use the existing editExam function for live exams
                Teacher.editExam(examId);
            },
            
            viewUserResult: async (attemptId) => {
                const c = document.getElementById('app-container');
                c.innerHTML = '<div class="p-10 text-center"><div class="loader mx-auto"></div></div>';
                
                const attSnap = await getDoc(doc(db, "attempts", attemptId));
                if(!attSnap.exists()) return;
                const att = attSnap.data();
                const exam = window.ExamCache[att.examId];
                if(!exam) { 
                    c.innerHTML = '<div class="p-10 text-center">Exam Deleted</div>'; 
                    return; 
                }
                
                const qs = JSON.parse(exam.questions);
                
                // Calculate accuracy
                const totalQuestions = qs.length;
                const correctAnswers = qs.reduce((acc, q, i) => {
                    return acc + (att.answers[i] === q.correct ? 1 : 0);
                }, 0);
                const accuracy = totalQuestions > 0 ? ((correctAnswers / totalQuestions) * 100).toFixed(2) : 0;
                
                // Get rank data
                const rankQuery = query(collection(db, "attempts"), where("examId", "==", exam.id), orderBy("score", "desc"));
                const rankSnap = await getDocs(rankQuery);
                const totalParticipants = rankSnap.size;
                let userRank = 'N/A';
                let highestScore = 0;
                let highestAccuracy = 0;
                
                rankSnap.docs.forEach((doc, index) => {
                    const attempt = doc.data();
                    if (attempt.userId === att.userId) userRank = index + 1;
                    if (parseFloat(attempt.score) > highestScore) highestScore = parseFloat(attempt.score);
                    
                    // Calculate accuracy for each attempt
                    const correct = qs.reduce((acc, q, i) => {
                        return acc + (attempt.answers[i] === q.correct ? 1 : 0);
                    }, 0);
                    const attemptAccuracy = totalQuestions > 0 ? ((correct / totalQuestions) * 100).toFixed(2) : 0;
                    if (parseFloat(attemptAccuracy) > highestAccuracy) highestAccuracy = parseFloat(attemptAccuracy);
                });
                
                // Calculate time taken
                let timeTaken = 'N/A';
                if (att.submittedAt && exam.startTime) {
                    const startTime = new Date(exam.startTime);
                    const submitTime = att.submittedAt.toDate();
                    const timeDiff = Math.floor((submitTime - startTime) / (1000 * 60)); // in minutes
                    timeTaken = `${Math.min(timeDiff, exam.duration)} মিনিট`;
                }
                
                // Pagination and filtering setup
                window.currentResultPage = 1;
                window.resultFilter = 'all';
                window.filteredQuestions = [...qs];
                
                const renderQuestions = (questionsToShow) => {
                    let h = '';
                    let stats = { correct: 0, wrong: 0, skip: 0 };
                    
                    questionsToShow.forEach((q,i) => {
                        const originalIndex = qs.indexOf(q);
                        const u = att.answers[originalIndex];
                        const corr = q.correct;
                        let st = 'skipped';
                        let badge = '<span class="text-amber-600 font-bold text-xs">Skipped</span>';
                        
                        if(u === corr) { 
                            st = 'correct'; 
                            stats.correct++; 
                            badge = '<span class="text-emerald-600 font-bold text-xs">Correct</span>'; 
                        } else if (u !== null) { 
                            st = 'wrong'; 
                            stats.wrong++; 
                            badge = '<span class="text-red-600 font-bold text-xs">Wrong</span>'; 
                        } else { 
                            stats.skip++; 
                        }
                        
                        // Apply filter
                        if (window.resultFilter !== 'all') {
                            if (window.resultFilter === 'correct' && st !== 'correct') return;
                            if (window.resultFilter === 'wrong' && st !== 'wrong') return;
                            if (window.resultFilter === 'skipped' && st !== 'skipped') return;
                        }
                        
                        // Render question with math if needed
                        let questionHTML = q.q;
                        if (q.q.includes('\\') || q.q.includes('^') || q.q.includes('_')) {
                            questionHTML = `<span class="math-render">\\(${q.q}\\)</span>`;
                        }
                        
                        h += `<div class="ans-card ${st} p-4 rounded-xl mb-4 bg-white dark:bg-dark-secondary shadow-sm border dark:border-dark-tertiary">
                            <div class="flex justify-between mb-2 pb-2 border-b border-black/5 dark:border-dark-tertiary">
                                <span class="font-bold text-sm text-slate-700 dark:text-white">Q${originalIndex+1}</span>
                                ${badge}
                            </div>
                            <p class="text-sm font-semibold mb-3 text-slate-800 dark:text-white math-render">${questionHTML}</p>
                            <div class="space-y-1">
                                ${q.options.map((o,oi)=>{
                                    let cls="opt-res bg-white dark:bg-dark-tertiary text-slate-500 dark:text-slate-400";
                                    let icon = "";
                                    if(oi===corr) { 
                                        cls="opt-res right bg-emerald-50 dark:bg-emerald-900 border-emerald-200 dark:border-emerald-700"; 
                                        icon='<i class="fas fa-check float-right mt-1 text-emerald-600 dark:text-emerald-400"></i>'; 
                                    } else if(oi===u && u!==corr) { 
                                        cls="opt-res wrong-select bg-red-50 dark:bg-red-900 border-red-200 dark:border-red-700"; 
                                        icon='<i class="fas fa-times float-right mt-1 text-red-600 dark:text-red-400"></i>'; 
                                    }
                                    
                                    // Render option with math if needed
                                    let optionText = o;
                                    if (o.includes('\\') || o.includes('^') || o.includes('_')) {
                                        optionText = `<span class="math-render">\\(${o}\\)</span>`;
                                    }
                                    
                                    return `<div class="${cls}"><span>${String.fromCharCode(65+oi)}. ${optionText}</span> ${icon}</div>`;
                                }).join('')}
                            </div>
                            <div class="mt-3 text-xs bg-white/60 dark:bg-dark-tertiary p-3 rounded border border-slate-200 dark:border-dark-tertiary">
                                <span class="font-bold text-indigo-600 dark:text-indigo-400 block mb-1">ব্যাখ্যা:</span>
                                ${q.expl || "No explanation provided."}
                            </div>
                        </div>`;
                    });
                    
                    return { html: h, stats: stats };
                };
                
                const updateResultView = () => {
                    const questionsPerPage = 25;
                    const startIndex = (window.currentResultPage - 1) * questionsPerPage;
                    const endIndex = startIndex + questionsPerPage;
                    const currentQuestions = window.filteredQuestions.slice(startIndex, endIndex);
                    
                    const result = renderQuestions(currentQuestions);
                    const totalPages = Math.ceil(window.filteredQuestions.length / questionsPerPage);
                    
                    // Filter buttons
                    const filterButtons = `
                        <div class="flex gap-2 mb-4 flex-wrap">
                            <button onclick="Teacher.setResultFilter('all')" class="filter-btn ${window.resultFilter === 'all' ? 'active bg-indigo-600 text-white border-indigo-600' : ''}">
                                All (${qs.length})
                            </button>
                            <button onclick="Teacher.setResultFilter('correct')" class="filter-btn correct ${window.resultFilter === 'correct' ? 'active' : ''}">
                                Correct (${correctAnswers})
                            </button>
                            <button onclick="Teacher.setResultFilter('wrong')" class="filter-btn wrong ${window.resultFilter === 'wrong' ? 'active' : ''}">
                                Wrong (${totalQuestions - correctAnswers - (qs.length - att.answers.filter(a => a !== null).length)})
                            </button>
                            <button onclick="Teacher.setResultFilter('skipped')" class="filter-btn skipped ${window.resultFilter === 'skipped' ? 'active' : ''}">
                                Skipped (${qs.length - att.answers.filter(a => a !== null).length})
                            </button>
                        </div>
                    `;
                    
                    // Pagination controls
                    const pagination = totalPages > 1 ? `
                        <div class="pagination">
                            <button onclick="Teacher.prevResultPage()" class="page-btn" ${window.currentResultPage === 1 ? 'disabled' : ''}>
                                <i class="fas fa-chevron-left"></i> Previous
                            </button>
                            <span class="text-sm">Page ${window.currentResultPage} of ${totalPages}</span>
                            <button onclick="Teacher.nextResultPage()" class="page-btn" ${window.currentResultPage === totalPages ? 'disabled' : ''}>
                                Next <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    ` : '';
                    
                    // COMPACT Result Summary Card
                    const header = `
                    <div class="compact-summary-card">
                        <div class="compact-header">
                            <div>
                                <div class="compact-title">${att.userName}</div>
                                <div class="compact-date">${exam.title}</div>
                            </div>
                            <div class="compact-score-section">
                                <div class="compact-score">${parseFloat(att.score).toFixed(2)}</div>
                                <div class="compact-accuracy">${accuracy}% Accuracy</div>
                            </div>
                        </div>
                        <div class="compact-grid">
                            <div class="compact-stat-item">
                                <div class="compact-stat-value">${totalQuestions}</div>
                                <div class="compact-stat-label">Total</div>
                            </div>
                            <div class="compact-stat-item">
                                <div class="compact-stat-value">${correctAnswers}</div>
                                <div class="compact-stat-label">Correct</div>
                            </div>
                            <div class="compact-stat-item">
                                <div class="compact-stat-value">${totalQuestions - correctAnswers - (qs.length - att.answers.filter(a => a !== null).length)}</div>
                                <div class="compact-stat-label">Wrong</div>
                            </div>
                            <div class="compact-stat-item">
                                <div class="compact-stat-value">${qs.length - att.answers.filter(a => a !== null).length}</div>
                                <div class="compact-stat-label">Skipped</div>
                            </div>
                            <div class="compact-stat-item">
                                <div class="compact-stat-value">${userRank}</div>
                                <div class="compact-stat-label">Rank</div>
                            </div>
                            <div class="compact-stat-item">
                                <div class="compact-stat-value">${timeTaken}</div>
                                <div class="compact-stat-label">Time</div>
                            </div>
                            <div class="compact-stat-item">
                                <div class="compact-stat-value">${totalParticipants}</div>
                                <div class="compact-stat-label">Participants</div>
                            </div>
                            <div class="compact-stat-item">
                                <div class="compact-stat-value">${highestScore.toFixed(2)}</div>
                                <div class="compact-stat-label">Top Score</div>
                            </div>
                        </div>
                    </div>
                    `;
                    
                    c.innerHTML = `
                        <div class="p-5 pb-24">
                            <button onclick="Teacher.rankView()" class="mb-4 text-xs font-bold text-slate-500">
                                <i class="fas fa-arrow-left"></i> Back to Rankings
                            </button>
                            <h2 class="font-bold text-xl mb-4 dark:text-white">User Result Analysis</h2>
                            ${header}
                            ${filterButtons}
                            ${result.html || '<div class="text-center p-10 text-slate-400">No questions match the filter</div>'}
                            ${pagination}
                        </div>
                    `;
                    
                    MathJax.typesetPromise();
                };
                
                // Set initial filtered questions
                window.filteredQuestions = [...qs];
                updateResultView();
                
                // Store functions for pagination and filtering
                window.Teacher.setResultFilter = (filter) => {
                    window.resultFilter = filter;
                    window.currentResultPage = 1;
                    
                    if (filter === 'all') {
                        window.filteredQuestions = [...qs];
                    } else {
                        window.filteredQuestions = qs.filter((q, i) => {
                            const u = att.answers[i];
                            const corr = q.correct;
                            let st = 'skipped';
                            if(u === corr) st = 'correct';
                            else if (u !== null) st = 'wrong';
                            
                            return st === filter;
                        });
                    }
                    
                    updateResultView();
                };
                
                window.Teacher.prevResultPage = () => {
                    if (window.currentResultPage > 1) {
                        window.currentResultPage--;
                        updateResultView();
                    }
                };
                
                window.Teacher.nextResultPage = () => {
                    const totalPages = Math.ceil(window.filteredQuestions.length / 25);
                    if (window.currentResultPage < totalPages) {
                        window.currentResultPage++;
                        updateResultView();
                    }
                };
            },

            rankView: () => {
                // Check if group is selected
                if (!AppState.selectedGroup) {
                    Teacher.selectGroupView('rank');
                    return;
                }
                
                // Hide floating math button
                document.getElementById('floating-math-btn').classList.add('hidden');
                document.getElementById('math-symbols-panel').classList.remove('show');
                
                 const c = document.getElementById('app-container');
                 // Filter only live exams for the selected group that are published and not cancelled
                 const exams = Object.values(window.ExamCache)
                     .filter(e => e.type === 'live' && 
                            e.groupId === AppState.selectedGroup.id && 
                            e.createdBy === AppState.currentUser.id &&
                            e.resultPublished &&
                            !e.cancelled)
                     .sort((a,b) => b.createdAt - a.createdAt);
                 
                 let h = '';
                 if (exams.length === 0) {
                     h = '<div class="text-center p-10 text-slate-400">No published live exams found</div>';
                 } else {
                     exams.forEach(e => {
                         const date = moment(e.createdAt.toDate()).format('DD MMM, YYYY');
                         h += `<div onclick="Teacher.viewRank('${e.id}', '${e.title}')" class="bg-white dark:bg-dark-secondary p-4 rounded-xl shadow-sm border border-slate-100 dark:border-dark-tertiary mb-3 flex justify-between items-center cursor-pointer hover:bg-slate-50 dark:hover:bg-dark-tertiary transition">
                             <div>
                                 <div class="font-bold text-sm text-slate-800 dark:text-white">${e.title}</div>
                                 <div class="text-xs text-slate-400 mt-1">
                                     <span class="uppercase bg-slate-100 dark:bg-dark-tertiary px-1 rounded mr-1">${e.type}</span> ${date}
                                 </div>
                             </div>
                             <div class="w-8 h-8 rounded-full bg-slate-50 dark:bg-dark-tertiary flex items-center justify-center text-slate-600 dark:text-slate-400">
                                 <i class="fas fa-chevron-right"></i>
                             </div>
                         </div>`;
                     });
                 }
                 
                 c.innerHTML = `<div class="p-5 pb-20">
                     <div class="flex justify-between items-center mb-6">
                         <h2 class="text-xl font-bold font-en dark:text-white">Live Exam Rankings</h2>
                         <div class="text-xs bg-indigo-100 dark:bg-indigo-900 text-indigo-600 dark:text-indigo-300 px-3 py-1.5 rounded-lg">
                             <i class="fas fa-users mr-1"></i> ${AppState.selectedGroup.name}
                         </div>
                     </div>
                     <p class="text-sm text-slate-500 dark:text-slate-400 mb-6">Only showing published live exams for the selected group.</p>
                     ${h}
                 </div>`;
            },
            
            viewRank: async (eid, title) => {
                const c = document.getElementById('app-container');
                const exam = window.ExamCache[eid];
                if(!exam) return;
                
                const q = query(collection(db, "attempts"), where("examId", "==", eid), orderBy("score", "desc"));
                
                // রিয়েল টাইম র‍্যাংক লিসেনার
                const unsub = onSnapshot(q, (snap) => {
                    let rows = '';
                    let highestScore = 0;
                    let highestAccuracy = 0;
                    const qs = JSON.parse(exam.questions);
                    
                    snap.docs.forEach((d, i) => {
                        const a = d.data();
                        const correctAnswers = qs.reduce((acc, q, idx) => acc + (a.answers[idx] === q.correct ? 1 : 0), 0);
                        const accuracy = ((correctAnswers / qs.length) * 100).toFixed(2);
                        
                        if (parseFloat(a.score) > highestScore) highestScore = parseFloat(a.score);
                        if (parseFloat(accuracy) > highestAccuracy) highestAccuracy = parseFloat(accuracy);
                        
                        let rankIcon = `<span class="font-bold text-slate-500 text-sm ml-2">${i+1}</span>`;
                        if(i===0) rankIcon = '🥇';
                        if(i===1) rankIcon = '🥈';
                        if(i===2) rankIcon = '🥉';
                        
                        rows += `
                        <div onclick="Teacher.viewUserResult('${d.id}')" class="flex items-center p-3 border-b dark:bg-dark-secondary hover:bg-slate-50 dark:hover:bg-dark-tertiary cursor-pointer">
                            <div class="w-10 text-center">${rankIcon}</div>
                            <div class="flex-1 ml-3 font-bold text-sm dark:text-white truncate">${a.userName}</div>
                            <div class="font-bold text-indigo-600 dark:text-indigo-400 bg-indigo-50 dark:bg-indigo-900 px-2 py-1 rounded text-xs">${parseFloat(a.score).toFixed(2)}</div>
                        </div>`;
                    });
                    
                    c.innerHTML = `
                        <div class="p-5 pb-20">
                            <button onclick="Teacher.rankView()" class="text-xs font-bold mb-4 text-slate-500 dark:text-slate-400">
                                <i class="fas fa-arrow-left"></i> Back
                            </button>
                            <div class="bg-indigo-600 rounded-2xl p-6 text-white shadow-lg mb-6">
                                <h3 class="font-bold text-lg">${title}</h3>
                                <div class="text-xs mt-2">অংশগ্রহণকারী: ${snap.size} জন</div>
                            </div>
                            <div class="grid grid-cols-2 gap-3 text-center mb-6">
                                <div class="p-4 bg-white dark:bg-dark-secondary rounded-xl border dark:border-dark-tertiary">
                                    <div class="text-2xl font-bold text-slate-800 dark:text-white">${highestScore.toFixed(2)}</div>
                                    <div class="text-[10px] uppercase text-slate-500 font-bold">সর্বোচ্চ স্কোর</div>
                                </div>
                                <div class="p-4 bg-white dark:bg-dark-secondary rounded-xl border dark:border-dark-tertiary">
                                    <div class="text-2xl font-bold text-slate-800 dark:text-white">${highestAccuracy}%</div>
                                    <div class="text-[10px] uppercase text-slate-500 font-bold">সর্বোচ্চ Accuracy</div>
                                </div>
                            </div>
                            <div class="rounded-xl border dark:border-dark-tertiary overflow-hidden">
                                ${rows || '<div class="p-10 text-center text-slate-400">No results found</div>'}
                            </div>
                        </div>
                    `;
                });
                window.unsubscribes.push(unsub);
            },
            
            managementView: () => {
                // Check if group is selected
                if (!AppState.selectedGroup) {
                    Teacher.selectGroupView('management');
                    return;
                }
                
                // Hide floating math button
                document.getElementById('floating-math-btn').classList.add('hidden');
                document.getElementById('math-symbols-panel').classList.remove('show');
                
                document.getElementById('app-container').innerHTML = `
                <div class="p-5 pb-20">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold font-en text-slate-800 dark:text-white">Management Hub</h2>
                        <div class="text-xs bg-indigo-100 dark:bg-indigo-900 text-indigo-600 dark:text-indigo-300 px-3 py-1.5 rounded-lg">
                            <i class="fas fa-users mr-1"></i> ${AppState.selectedGroup.name}
                        </div>
                    </div>
                    <div class="management-list">
                         <div class="management-item" onclick="Teacher.liveExamManagementView()">
                             <div class="flex items-center gap-3">
                                 <div class="w-12 h-12 bg-emerald-50 dark:bg-emerald-900 rounded-full flex items-center justify-center text-emerald-600 dark:text-emerald-400 text-xl">
                                     <i class="fas fa-broadcast-tower"></i>
                                 </div>
                                 <div>
                                     <div class="font-bold text-sm text-slate-700 dark:text-white">Live Exam Management</div>
                                     <div class="text-xs text-slate-500 dark:text-slate-400">Cancel and publish ongoing live exams</div>
                                 </div>
                             </div>
                             <i class="fas fa-chevron-right text-slate-400"></i>
                         </div>
                         
                         <div class="management-item" onclick="Teacher.manageGroupsView()">
                             <div class="flex items-center gap-3">
                                 <div class="w-12 h-12 bg-amber-50 dark:bg-amber-900 rounded-full flex items-center justify-center text-amber-600 dark:text-amber-400 text-xl">
                                     <i class="fas fa-users"></i>
                                 </div>
                                 <div>
                                     <div class="font-bold text-sm text-slate-700 dark:text-white">Group Management</div>
                                     <div class="text-xs text-slate-500 dark:text-slate-400">Manage your student groups</div>
                                 </div>
                             </div>
                             <i class="fas fa-chevron-right text-slate-400"></i>
                         </div>
                         
                         <div class="management-item" onclick="Teacher.archiveGroupsView()">
                             <div class="flex items-center gap-3">
                                 <div class="w-12 h-12 bg-rose-50 dark:bg-rose-900 rounded-full flex items-center justify-center text-rose-600 dark:text-rose-400 text-xl">
                                     <i class="fas fa-archive"></i>
                                 </div>
                                 <div>
                                     <div class="font-bold text-sm text-slate-700 dark:text-white">Archive Group</div>
                                     <div class="text-xs text-slate-500 dark:text-slate-400">View and manage archived groups</div>
                                 </div>
                             </div>
                             <i class="fas fa-chevron-right text-slate-400"></i>
                         </div>
                    </div>
                </div>`;
            },
            
            createNewGroupModal: async () => {
                const { value: name } = await Swal.fire({
                    title: 'Create New Group',
                    input: 'text',
                    inputLabel: 'Group Name',
                    showCancelButton: true,
                    inputValidator: (value) => { 
                        if (!value) return 'Name is required!';
                        if (value.length < 3) return 'Group name must be at least 3 characters long!';
                    }
                });
                if (name) Teacher.createGroup(name);
            },
            
            createGroup: async (name) => {
                // Generate group code
                const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
                const numbers = '0123456789';
                let groupCode = '';
                
                // Generate 5 random letters
                for (let i = 0; i < 5; i++) {
                    groupCode += letters.charAt(Math.floor(Math.random() * letters.length));
                }
                
                // Generate 5 random numbers
                for (let i = 0; i < 5; i++) {
                    groupCode += numbers.charAt(Math.floor(Math.random() * numbers.length));
                }
                
                try {
                    const groupData = {
                        name: name,
                        groupCode: groupCode,
                        teacherId: AppState.currentUser.id,
                        teacherCode: AppState.currentUser.teacherCode,
                        teacherName: AppState.currentUser.fullName,
                        archived: false,
                        approvalRequired: false,
                        joinEnabled: true,
                        studentIds: [],
                        createdAt: new Date(),
                        updatedAt: new Date()
                    };
                    
                    await addDoc(collection(db, "groups"), groupData);
                    
                    Swal.fire({
                        title: 'Group Created Successfully!',
                        html: `
                            <div class="text-left">
                                <p class="mb-2"><strong>Group Name:</strong> ${name}</p>
                                <p class="mb-2"><strong>Group Code:</strong> <code class="bg-slate-100 dark:bg-dark-tertiary p-1 rounded font-bold">${groupCode}</code></p>
                                <p class="text-sm text-slate-600 dark:text-slate-400">Share this code with students to join your group</p>
                            </div>
                        `,
                        icon: 'success',
                        confirmButtonText: 'OK'
                    }).then(() => {
                        Teacher.loadGroupsForSwitcher();
                        Teacher.manageGroupsView();
                    });
                    
                } catch (error) {
                    Swal.fire('Error', 'Failed to create group: ' + error.message, 'error');
                }
            },
            
            manageGroupsView: async () => {
                document.getElementById('app-container').innerHTML = `
                <div class="p-5">
                    <button onclick="Teacher.managementView()" class="mb-4 text-xs font-bold text-slate-500 dark:text-slate-400">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                    
                    <h2 class="text-xl font-bold mb-6 font-en text-slate-800 dark:text-white">Group Management</h2>
                    
                    <div class="mb-6 bg-white dark:bg-dark-secondary p-5 rounded-2xl shadow-sm border dark:border-dark-tertiary">
                        <h3 class="font-bold text-lg mb-4 dark:text-white">Create New Group</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-bold mb-1 dark:text-white">Group Name</label>
                                <input type="text" id="group-name" class="w-full p-3 border dark:border-dark-tertiary dark:bg-black dark:text-white rounded-xl" placeholder="e.g., Class 10 Batch-1">
                            </div>
                            
                            <button onclick="Teacher.createGroupFromInput()" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-4 rounded-xl font-bold shadow-lg">
                                Create Group
                            </button>
                        </div>
                    </div>
                    
                    <div id="groups-container">
                        <div class="text-center p-4 text-slate-400">Loading groups...</div>
                    </div>
                </div>`;
                
                await Teacher.loadTeacherGroups();
            },
            
            createGroupFromInput: async () => {
                const name = document.getElementById('group-name').value.trim();
                if (!name) {
                    Swal.fire('Error', 'Group name is required', 'error');
                    return;
                }
                await Teacher.createGroup(name);
            },
            
            loadTeacherGroups: async () => {
                try {
                    const groupsQuery = query(collection(db, "groups"), 
                        where("teacherId", "==", AppState.currentUser.id),
                        where("archived", "==", false),
                        orderBy("createdAt", "desc"));
                    const groupsSnap = await getDocs(groupsQuery);
                    
                    const groups = [];
                    groupsSnap.forEach(doc => {
                        groups.push({ id: doc.id, ...doc.data() });
                    });
                    
                    Teacher.teacherGroups = groups;
                    
                    if (groups.length === 0) {
                        document.getElementById('groups-container').innerHTML = `
                            <div class="text-center p-4 text-slate-400">
                                No active groups found
                            </div>
                        `;
                        return;
                    }
                    
                    // Display groups with toggle switches for join and approval
                    let html = '<div class="group-grid">';
                    
                    groups.forEach(group => {
                        html += `
                            <div class="group-card cursor-pointer" onclick="Teacher.viewGroupStudents('${group.id}')">
                                <div class="flex justify-between items-start mb-3">
                                    <div>
                                        <h3 class="font-bold text-lg dark:text-white">${group.name}</h3>
                                        <p class="text-xs text-slate-500 dark:text-slate-400">${group.studentIds ? group.studentIds.length : 0} students</p>
                                    </div>
                                    <div class="three-dot-menu relative">
                                        <button class="three-dot-btn" onclick="event.stopPropagation(); Teacher.toggleGroupMenu('${group.id}')">
                                            <i class="fas fa-ellipsis-v text-slate-400"></i>
                                        </button>
                                        <div class="dot-menu-dropdown dark:bg-dark-secondary dark:border-dark-tertiary" id="group-menu-${group.id}">
                                            <div class="menu-item rename dark:text-purple-400" onclick="event.stopPropagation(); Teacher.renameGroup('${group.id}', '${group.name}')">
                                                <i class="fas fa-pencil-alt"></i>
                                                Rename
                                            </div>
                                            <div class="menu-item archive dark:text-amber-400" onclick="event.stopPropagation(); Teacher.archiveGroupConfirm('${group.id}', '${group.groupCode}')">
                                                <i class="fas fa-archive"></i>
                                                Move to Archive
                                            </div>
                                            <div class="menu-item delete dark:text-red-400" onclick="event.stopPropagation(); Teacher.deleteGroupConfirm('${group.id}', '${group.groupCode}')">
                                                <i class="fas fa-trash"></i>
                                                Delete
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="group-code">${group.groupCode}</div>
                                
                                <!-- Toggle switches for join and approval -->
                                <div class="mt-4 space-y-3">
                                    <div class="flex items-center justify-between">
                                        <span class="text-sm font-medium dark:text-white">Allow Join</span>
                                        <label class="toggle-switch">
                                            <input type="checkbox" ${group.joinEnabled ? 'checked' : ''} onclick="event.stopPropagation(); Teacher.toggleGroupSetting('${group.id}', 'joinEnabled', this.checked)">
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <span class="text-sm font-medium dark:text-white">Approval Required</span>
                                        <label class="toggle-switch">
                                            <input type="checkbox" ${group.approvalRequired ? 'checked' : ''} onclick="event.stopPropagation(); Teacher.toggleGroupSetting('${group.id}', 'approvalRequired', this.checked)">
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="text-xs text-slate-500 dark:text-slate-400 mt-3">
                                    Created: ${moment(group.createdAt?.toDate()).format('DD MMM YYYY')}
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    
                    document.getElementById('groups-container').innerHTML = html;
                } catch (error) {
                    console.error('Error loading groups:', error);
                    document.getElementById('groups-container').innerHTML = '<div class="text-center p-4 text-red-500">Error loading groups</div>';
                }
            },
            
            toggleGroupMenu: (groupId) => {
                event.stopPropagation();
                // Close all other menus
                document.querySelectorAll('.dot-menu-dropdown').forEach(dropdown => {
                    if (dropdown.id !== `group-menu-${groupId}`) {
                        dropdown.classList.remove('show');
                    }
                });
                
                // Toggle current menu
                const menu = document.getElementById(`group-menu-${groupId}`);
                if (menu) {
                    menu.classList.toggle('show');
                }
            },
            
            toggleGroupSetting: async (groupId, setting, value) => {
                try {
                    await updateDoc(doc(db, "groups", groupId), {
                        [setting]: value,
                        updatedAt: new Date()
                    });
                    
                    // Update local groups
                    const group = Teacher.teacherGroups.find(g => g.id === groupId);
                    if (group) {
                        group[setting] = value;
                    }
                } catch (error) {
                    Swal.fire('Error', 'Failed to update setting: ' + error.message, 'error');
                }
            },
            
            viewGroupStudents: async (groupId) => {
                try {
                    const groupDoc = await getDoc(doc(db, "groups", groupId));
                    if (!groupDoc.exists()) return;
                    
                    const group = { id: groupDoc.id, ...groupDoc.data() };
                    
                    // Load students
                    let students = [];
                    if (group.studentIds && group.studentIds.length > 0) {
                        const studentPromises = group.studentIds.map(async (studentId) => {
                            try {
                                const studentDoc = await getDoc(doc(db, "students", studentId));
                                if (studentDoc.exists()) {
                                    const studentData = studentDoc.data();
                                    // Filter out blocked students
                                    if (studentData.blocked) return null;
                                    return { id: studentDoc.id, ...studentData, groupStatus: 'active' };
                                }
                            } catch (error) {
                                console.error('Error loading student:', error);
                            }
                            return null;
                        });
                        
                        const studentResults = await Promise.all(studentPromises);
                        students = studentResults.filter(s => s !== null);
                    }
                    
                    // Load pending approval requests
                    const requestsQuery = query(collection(db, "join_requests"), 
                        where("groupId", "==", groupId),
                        where("status", "==", "pending"));
                    const requestsSnap = await getDocs(requestsQuery);
                    
                    const pendingStudents = [];
                    requestsSnap.forEach(doc => {
                        const request = doc.data();
                        pendingStudents.push({
                            id: doc.id,
                            studentId: request.studentId,
                            studentName: request.studentName,
                            studentEmail: request.studentEmail,
                            requestedAt: request.requestedAt,
                            status: 'pending'
                        });
                    });
                    
                    // Combine all students
                    const allStudents = [
                        ...students.map(s => ({ ...s, status: 'active' })),
                        ...pendingStudents.map(p => ({ 
                            id: p.id, 
                            studentId: p.studentId,
                            fullName: p.studentName,
                            email: p.studentEmail,
                            requestedAt: p.requestedAt,
                            status: 'pending'
                        }))
                    ];
                    
                    document.getElementById('app-container').innerHTML = `
                    <div class="p-5">
                        <button onclick="Teacher.manageGroupsView()" class="mb-4 text-xs font-bold text-slate-500 dark:text-slate-400">
                            <i class="fas fa-arrow-left"></i> Back to Groups
                        </button>
                        
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h2 class="text-xl font-bold font-en text-slate-800 dark:text-white">${group.name}</h2>
                                <p class="text-sm text-slate-500 dark:text-slate-400">${allStudents.length} students</p>
                            </div>
                            <div class="group-code">${group.groupCode}</div>
                        </div>
                        
                        <!-- Filter Tabs -->
                        <div class="filter-tabs" id="student-filter-tabs">
                            <div class="filter-tab active" onclick="Teacher.filterStudents('all')">All (${allStudents.length})</div>
                            <div class="filter-tab" onclick="Teacher.filterStudents('active')">Active (${students.length})</div>
                            <div class="filter-tab" onclick="Teacher.filterStudents('pending')">Pending Approval (${pendingStudents.length})</div>
                            <div class="filter-tab" onclick="Teacher.filterStudents('disabled')">Disabled (${students.filter(s => s.disabled).length})</div>
                            <div class="filter-tab" onclick="Teacher.filterStudents('blocked')">Blocked (0)</div>
                        </div>
                        
                        <!-- Student List -->
                        <div class="student-list-container" id="student-list">
                            ${allStudents.length === 0 ? `
                                <div class="text-center p-10 text-slate-400">
                                    <i class="fas fa-users text-4xl mb-4 opacity-30"></i>
                                    <p>No students in this group yet</p>
                                </div>
                            ` : allStudents.map(student => {
                                let statusClass = 'status-active';
                                let statusText = 'Active';
                                
                                if (student.status === 'pending') {
                                    statusClass = 'status-pending';
                                    statusText = 'Pending';
                                } else if (student.disabled) {
                                    statusClass = 'status-disabled';
                                    statusText = 'Disabled';
                                } else if (student.blocked) {
                                    statusClass = 'status-blocked';
                                    statusText = 'Blocked';
                                }
                                
                                return `
                                    <div class="student-item cursor-pointer" onclick="Teacher.viewStudentProfile('${student.studentId || student.id}', '${groupId}')">
                                        <div>
                                            <div class="font-bold text-sm dark:text-white">${student.fullName || student.name || student.studentName || 'No Name'}</div>
                                            <div class="text-xs text-slate-500 dark:text-slate-400">${student.email || student.studentEmail}</div>
                                        </div>
                                        <div>
                                            <span class="student-status ${statusClass}">${statusText}</span>
                                            ${student.status === 'pending' ? `
                                                <div class="mt-2 flex gap-2">
                                                    <button onclick="event.stopPropagation(); Teacher.approveStudentRequest('${student.id}', '${groupId}')" class="text-xs bg-emerald-600 text-white px-2 py-1 rounded">
                                                        Approve
                                                    </button>
                                                    <button onclick="event.stopPropagation(); Teacher.rejectStudentRequest('${student.id}', '${groupId}')" class="text-xs bg-red-600 text-white px-2 py-1 rounded">
                                                        Reject
                                                    </button>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>`;
                    
                    // Store current students for filtering
                    window.currentGroupStudents = allStudents;
                    window.currentGroupId = groupId;
                    
                } catch (error) {
                    console.error('Error loading group students:', error);
                    document.getElementById('app-container').innerHTML = '<div class="text-center p-10 text-red-500">Error loading students</div>';
                }
            },
            
            viewStudentProfile: async (studentId, groupId) => {
                try {
                    const studentDoc = await getDoc(doc(db, "students", studentId));
                    if (!studentDoc.exists()) return;
                    const s = studentDoc.data();

                    document.getElementById('app-container').innerHTML = `
                    <div class="p-5 max-w-md mx-auto">
                        <button onclick="Teacher.viewGroupStudents('${groupId}')" class="mb-4 text-xs font-bold text-slate-500 dark:text-slate-400">
                            <i class="fas fa-arrow-left"></i> Back
                        </button>
                        
                        <div class="bg-white dark:bg-dark-secondary p-6 rounded-2xl shadow-sm border dark:border-dark-tertiary">
                            <h3 class="font-bold text-lg mb-4 dark:text-white">Edit Student Profile</h3>
                            <div class="space-y-3">
                                <div>
                                    <label class="text-xs font-bold dark:text-white">Full Name</label>
                                    <input id="edit-s-name" class="w-full p-2 border rounded dark:bg-black dark:text-white dark:border-dark-tertiary" value="${s.fullName || s.name || ''}">
                                </div>
                                
                                <div>
                                    <label class="text-xs font-bold dark:text-white">Phone</label>
                                    <input id="edit-s-phone" class="w-full p-2 border rounded dark:bg-black dark:text-white dark:border-dark-tertiary" value="${s.phone || ''}">
                                </div>
                                
                                <div>
                                    <label class="text-xs font-bold dark:text-white">Father's Phone</label>
                                    <input id="edit-s-fphone" class="w-full p-2 border rounded dark:bg-black dark:text-white dark:border-dark-tertiary" value="${s.fatherPhone || ''}">
                                </div>
                                
                                <div>
                                    <label class="text-xs font-bold dark:text-white">Mother's Phone</label>
                                    <input id="edit-s-mphone" class="w-full p-2 border rounded dark:bg-black dark:text-white dark:border-dark-tertiary" value="${s.motherPhone || ''}">
                                </div>
                                
                                <div>
                                    <label class="text-xs font-bold dark:text-white">School Name</label>
                                    <input id="edit-s-school" class="w-full p-2 border rounded dark:bg-black dark:text-white dark:border-dark-tertiary" value="${s.schoolName || ''}">
                                </div>
                                
                                <div>
                                    <label class="text-xs font-bold dark:text-white">College Name</label>
                                    <input id="edit-s-college" class="w-full p-2 border rounded dark:bg-black dark:text-white dark:border-dark-tertiary" value="${s.collegeName || ''}">
                                </div>
                                
                                <button onclick="Teacher.updateStudentProfileByTeacher('${studentId}', '${groupId}')" class="w-full bg-indigo-600 text-white py-2 rounded-lg font-bold mt-4">Update Profile</button>
                            </div>
                        </div>
                    </div>`;
                } catch (e) { 
                    console.error(e);
                    Swal.fire('Error', 'Failed to load student profile', 'error');
                }
            },
            
            updateStudentProfileByTeacher: async (studentId, groupId) => {
                const updateData = {
                    fullName: document.getElementById('edit-s-name').value,
                    phone: document.getElementById('edit-s-phone').value,
                    fatherPhone: document.getElementById('edit-s-fphone').value,
                    motherPhone: document.getElementById('edit-s-mphone').value,
                    schoolName: document.getElementById('edit-s-school').value,
                    collegeName: document.getElementById('edit-s-college').value,
                    updatedAt: new Date()
                };
                
                try {
                    await updateDoc(doc(db, "students", studentId), updateData);
                    Swal.fire('Success', 'Student profile updated', 'success');
                    Teacher.viewGroupStudents(groupId);
                } catch (e) { 
                    Swal.fire('Error', e.message, 'error'); 
                }
            },
            
            filterStudents: function(filter) {
                const tabs = document.querySelectorAll('#student-filter-tabs .filter-tab');
                tabs.forEach(tab => tab.classList.remove('active'));
                event.target.classList.add('active');
                
                let filteredStudents = [];
                
                if (filter === 'all') {
                    filteredStudents = window.currentGroupStudents;
                } else if (filter === 'active') {
                    filteredStudents = window.currentGroupStudents.filter(s => s.status === 'active' && !s.disabled);
                } else if (filter === 'pending') {
                    filteredStudents = window.currentGroupStudents.filter(s => s.status === 'pending');
                } else if (filter === 'disabled') {
                    filteredStudents = window.currentGroupStudents.filter(s => s.disabled);
                } else if (filter === 'blocked') {
                    filteredStudents = window.currentGroupStudents.filter(s => s.blocked);
                }
                
                const studentList = document.getElementById('student-list');
                if (filteredStudents.length === 0) {
                    studentList.innerHTML = `
                        <div class="text-center p-10 text-slate-400">
                            <i class="fas fa-users text-4xl mb-4 opacity-30"></i>
                            <p>No students found</p>
                        </div>
                    `;
                    return;
                }
                
                studentList.innerHTML = filteredStudents.map(student => {
                    let statusClass = 'status-active';
                    let statusText = 'Active';
                    
                    if (student.status === 'pending') {
                        statusClass = 'status-pending';
                        statusText = 'Pending';
                    } else if (student.disabled) {
                        statusClass = 'status-disabled';
                        statusText = 'Disabled';
                    } else if (student.blocked) {
                        statusClass = 'status-blocked';
                        statusText = 'Blocked';
                    }
                    
                    return `
                        <div class="student-item cursor-pointer" onclick="Teacher.viewStudentProfile('${student.studentId || student.id}', '${window.currentGroupId}')">
                            <div>
                                <div class="font-bold text-sm dark:text-white">${student.fullName || student.name || student.studentName || 'No Name'}</div>
                                <div class="text-xs text-slate-500 dark:text-slate-400">${student.email || student.studentEmail}</div>
                            </div>
                            <div>
                                <span class="student-status ${statusClass}">${statusText}</span>
                                ${student.status === 'pending' ? `
                                    <div class="mt-2 flex gap-2">
                                        <button onclick="event.stopPropagation(); Teacher.approveStudentRequest('${student.id}', '${window.currentGroupId}')" class="text-xs bg-emerald-600 text-white px-2 py-1 rounded">
                                            Approve
                                        </button>
                                        <button onclick="event.stopPropagation(); Teacher.rejectStudentRequest('${student.id}', '${window.currentGroupId}')" class="text-xs bg-red-600 text-white px-2 py-1 rounded">
                                            Reject
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            },
            
            toggleStudentStatus: async (studentId, status, value) => {
                try {
                    await updateDoc(doc(db, "students", studentId), {
                        [status]: value,
                        updatedAt: new Date()
                    });
                    
                    Swal.fire('Success', `Student ${status} ${value ? 'enabled' : 'disabled'}`, 'success').then(() => {
                        // Reload the view
                        Teacher.viewStudentProfile(studentId, window.currentGroupId);
                    });
                } catch (error) {
                    Swal.fire('Error', 'Failed to update student status', 'error');
                }
            },
            
            removeStudentFromGroup: async (studentId, groupId) => {
                const result = await Swal.fire({
                    title: 'Remove Student?',
                    text: "This student will be removed from the group",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    confirmButtonText: 'Remove'
                });
                
                if (result.isConfirmed) {
                    try {
                        const groupDoc = await getDoc(doc(db, "groups", groupId));
                        if (groupDoc.exists()) {
                            const group = groupDoc.data();
                            const updatedStudentIds = group.studentIds.filter(id => id !== studentId);
                            
                            await updateDoc(doc(db, "groups", groupId), {
                                studentIds: updatedStudentIds,
                                updatedAt: new Date()
                            });
                            
                            Swal.fire('Removed!', 'Student has been removed from the group', 'success').then(() => {
                                Teacher.viewGroupStudents(groupId);
                            });
                        }
                    } catch (error) {
                        Swal.fire('Error', 'Failed to remove student', 'error');
                    }
                }
            },
            
            approveStudentRequest: async (requestId, groupId) => {
                try {
                    const requestDoc = await getDoc(doc(db, "join_requests", requestId));
                    if (!requestDoc.exists()) return;
                    
                    const request = requestDoc.data();
                    
                    // Add student to group
                    const groupDoc = await getDoc(doc(db, "groups", groupId));
                    if (groupDoc.exists()) {
                        const group = groupDoc.data();
                        const updatedStudentIds = [...(group.studentIds || []), request.studentId];
                        
                        await updateDoc(doc(db, "groups", groupId), {
                            studentIds: arrayUnion(request.studentId),
                            updatedAt: new Date()
                        });
                    }
                    
                    // Update request status
                    await updateDoc(doc(db, "join_requests", requestId), {
                        status: 'approved',
                        approvedAt: new Date(),
                        approvedBy: AppState.currentUser.id
                    });
                    
                    Swal.fire('Approved!', 'Student has been added to the group', 'success').then(() => {
                        Teacher.viewGroupStudents(groupId);
                    });
                } catch (error) {
                    Swal.fire('Error', 'Failed to approve request', 'error');
                }
            },
            
            rejectStudentRequest: async (requestId, groupId) => {
                const result = await Swal.fire({
                    title: 'Reject Request?',
                    text: "This request will be rejected",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    confirmButtonText: 'Reject'
                });
                
                if (result.isConfirmed) {
                    try {
                        await updateDoc(doc(db, "join_requests", requestId), {
                            status: 'rejected',
                            rejectedAt: new Date(),
                            rejectedBy: AppState.currentUser.id
                        });
                        
                        Swal.fire('Rejected!', 'Request has been rejected', 'success').then(() => {
                            Teacher.viewGroupStudents(groupId);
                        });
                    } catch (error) {
                        Swal.fire('Error', 'Failed to reject request', 'error');
                    }
                }
            },
            
            renameGroup: async (groupId, currentName) => {
                const { value: newName } = await Swal.fire({
                    title: 'Rename Group',
                    input: 'text',
                    inputLabel: 'New Group Name',
                    inputValue: currentName,
                    showCancelButton: true,
                    inputValidator: (value) => {
                        if (!value) return 'You need to enter a new name!';
                    }
                });
                
                if (newName && newName !== currentName) {
                    try {
                        await updateDoc(doc(db, "groups", groupId), {
                            name: newName,
                            updatedAt: new Date()
                        });
                        
                        Swal.fire('Success', 'Group renamed successfully', 'success');
                        Teacher.loadTeacherGroups();
                        Teacher.loadGroupsForSwitcher();
                    } catch (error) {
                        Swal.fire('Error', 'Failed to rename group: ' + error.message, 'error');
                    }
                }
            },
            
            archiveGroupConfirm: async (groupId, groupCode) => {
                const { value: enteredCode } = await Swal.fire({
                    title: 'Archive Group?',
                    text: "Please enter the group code to confirm",
                    input: 'text',
                    inputPlaceholder: 'Enter group code',
                    showCancelButton: true,
                    confirmButtonColor: '#f59e0b',
                    confirmButtonText: 'Archive',
                    inputValidator: (value) => {
                        if (!value) return 'You need to enter the group code!';
                        if (value !== groupCode) return 'Group code does not match!';
                    }
                });
                
                if (enteredCode === groupCode) {
                    try {
                        await updateDoc(doc(db, "groups", groupId), {
                            archived: true,
                            updatedAt: new Date()
                        });
                        
                        // If this is the currently selected group, clear selection
                        if (AppState.selectedGroup && AppState.selectedGroup.id === groupId) {
                            AppState.selectedGroup = null;
                            localStorage.removeItem('selectedGroup');
                        }
                        
                        Swal.fire('Archived!', 'Group has been moved to archive.', 'success');
                        Teacher.loadTeacherGroups();
                        Teacher.loadGroupsForSwitcher();
                    } catch (error) {
                        Swal.fire('Error', 'Failed to archive group: ' + error.message, 'error');
                    }
                }
            },
            
            deleteGroupConfirm: async (groupId, groupCode) => {
                const { value: enteredCode } = await Swal.fire({
                    title: 'Delete Group?',
                    text: "This action cannot be undone. Please enter the group code to confirm",
                    input: 'text',
                    inputPlaceholder: 'Enter group code',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    confirmButtonText: 'Delete',
                    inputValidator: (value) => {
                        if (!value) return 'You need to enter the group code!';
                        if (value !== groupCode) return 'Group code does not match!';
                    }
                });
                
                if (enteredCode === groupCode) {
                    try {
                        await deleteDoc(doc(db, "groups", groupId));
                        
                        // If this is the currently selected group, clear selection
                        if (AppState.selectedGroup && AppState.selectedGroup.id === groupId) {
                            AppState.selectedGroup = null;
                            localStorage.removeItem('selectedGroup');
                        }
                        
                        Swal.fire('Deleted!', 'Group has been deleted.', 'success');
                        Teacher.loadTeacherGroups();
                        Teacher.loadGroupsForSwitcher();
                    } catch (error) {
                        Swal.fire('Error', 'Failed to delete group: ' + error.message, 'error');
                    }
                }
            },
            
            archiveGroupsView: async () => {
                document.getElementById('app-container').innerHTML = `
                <div class="p-5">
                    <button onclick="Teacher.managementView()" class="mb-4 text-xs font-bold text-slate-500 dark:text-slate-400">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                    
                    <h2 class="text-xl font-bold mb-6 font-en text-slate-800 dark:text-white">Archive Groups</h2>
                    
                    <div id="archive-groups-container">
                        <div class="text-center p-4 text-slate-400">Loading archived groups...</div>
                    </div>
                </div>`;
                
                await Teacher.loadArchiveGroups();
            },
            
            loadArchiveGroups: async () => {
                try {
                    const groupsQuery = query(collection(db, "groups"), 
                        where("teacherId", "==", AppState.currentUser.id),
                        where("archived", "==", true),
                        orderBy("createdAt", "desc"));
                    const groupsSnap = await getDocs(groupsQuery);
                    
                    const groups = [];
                    groupsSnap.forEach(doc => {
                        groups.push({ id: doc.id, ...doc.data() });
                    });
                    
                    if (groups.length === 0) {
                        document.getElementById('archive-groups-container').innerHTML = `
                            <div class="text-center p-10">
                                <div class="w-16 h-16 bg-slate-100 dark:bg-dark-tertiary rounded-full flex items-center justify-center text-slate-400 text-2xl mb-4 mx-auto">
                                    <i class="fas fa-archive"></i>
                                </div>
                                <h3 class="font-bold text-lg dark:text-white mb-2">No Archived Groups</h3>
                                <p class="text-sm text-slate-500 dark:text-slate-400">You don't have any archived groups yet</p>
                            </div>
                        `;
                        return;
                    }
                    
                    // Display archived groups
                    let html = '<div class="group-grid">';
                    
                    groups.forEach(group => {
                        html += `
                            <div class="group-card">
                                <div class="flex justify-between items-start mb-3">
                                    <div>
                                        <h3 class="font-bold text-lg dark:text-white">${group.name}</h3>
                                        <p class="text-xs text-slate-500 dark:text-slate-400">${group.studentIds ? group.studentIds.length : 0} students</p>
                                    </div>
                                    <div class="three-dot-menu relative">
                                        <button class="three-dot-btn" onclick="event.stopPropagation(); Teacher.toggleArchiveGroupMenu('${group.id}')">
                                            <i class="fas fa-ellipsis-v text-slate-400"></i>
                                        </button>
                                        <div class="dot-menu-dropdown dark:bg-dark-secondary dark:border-dark-tertiary" id="archive-group-menu-${group.id}">
                                            <div class="menu-item restore dark:text-emerald-400" onclick="event.stopPropagation(); Teacher.restoreGroupConfirm('${group.id}', '${group.groupCode}')">
                                                <i class="fas fa-undo"></i>
                                                Restore
                                            </div>
                                            <div class="menu-item delete dark:text-red-400" onclick="event.stopPropagation(); Teacher.deleteGroupConfirm('${group.id}', '${group.groupCode}')">
                                                <i class="fas fa-trash"></i>
                                                Delete
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="group-code">${group.groupCode}</div>
                                <div class="text-xs text-slate-500 dark:text-slate-400 mt-3">
                                    Created: ${moment(group.createdAt?.toDate()).format('DD MMM YYYY')}
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    
                    document.getElementById('archive-groups-container').innerHTML = html;
                } catch (error) {
                    console.error('Error loading archive groups:', error);
                    document.getElementById('archive-groups-container').innerHTML = '<div class="text-center p-4 text-red-500">Error loading archive groups</div>';
                }
            },
            
            toggleArchiveGroupMenu: (groupId) => {
                event.stopPropagation();
                // Close all other menus
                document.querySelectorAll('.dot-menu-dropdown').forEach(dropdown => {
                    if (dropdown.id !== `archive-group-menu-${groupId}`) {
                        dropdown.classList.remove('show');
                    }
                });
                
                // Toggle current menu
                const menu = document.getElementById(`archive-group-menu-${groupId}`);
                if (menu) {
                    menu.classList.toggle('show');
                }
            },
            
            restoreGroupConfirm: async (groupId, groupCode) => {
                const { value: enteredCode } = await Swal.fire({
                    title: 'Restore Group?',
                    text: "Please enter the group code to confirm",
                    input: 'text',
                    inputPlaceholder: 'Enter group code',
                    showCancelButton: true,
                    confirmButtonColor: '#10b981',
                    confirmButtonText: 'Restore',
                    inputValidator: (value) => {
                        if (!value) return 'You need to enter the group code!';
                        if (value !== groupCode) return 'Group code does not match!';
                    }
                });
                
                if (enteredCode === groupCode) {
                    try {
                        await updateDoc(doc(db, "groups", groupId), {
                            archived: false,
                            updatedAt: new Date()
                        });
                        
                        Swal.fire('Restored!', 'Group has been restored.', 'success');
                        Teacher.loadArchiveGroups();
                        Teacher.loadGroupsForSwitcher();
                    } catch (error) {
                        Swal.fire('Error', 'Failed to restore group: ' + error.message, 'error');
                    }
                }
            },
            
            publish: async (id) => {
                Swal.fire({ 
                    title:'Publish Result?', 
                    text: "Users will see the result immediately.", 
                    icon:'question', 
                    showCancelButton:true, 
                    confirmButtonColor:'#4f46e5', 
                    confirmButtonText:'Yes, Publish' 
                }).then(async(r)=>{
                    if(r.isConfirmed) { 
                        await updateDoc(doc(db, "exams", id), { 
                            resultPublished: true,
                            // End time update removed - শুধুমাত্র রেজাল্ট পাবলিশ হবে
                        }); 
                        Swal.fire('Published', 'Result is now live', 'success');
                        
                        // Immediately remove the exam card
                        const examCard = document.querySelector(`button[onclick*="${id}"]`)?.closest('.live-exam-card');
                        if (examCard) {
                            examCard.remove();
                        }
                        
                        // Check if no exams left
                        const remainingCards = document.querySelectorAll('.live-exam-card');
                        if (remainingCards.length === 0) {
                            const container = document.querySelector('#app-container');
                            if (container) {
                                const htmlSection = container.querySelector('.live-exam-card')?.parentNode;
                                if (htmlSection) {
                                    htmlSection.innerHTML = '<div class="text-center p-10 text-slate-400">No ongoing live exams found</div>';
                                }
                            }
                        }
                    }
                });
            },

            saveFolderStructureToFirebase: async () => {
                if (!AppState.currentUser || !AppState.selectedGroup) return;
                try {
                    const folderDocRef = doc(db, "folderStructures", `${AppState.currentUser.id}_${AppState.selectedGroup.id}`);
                    await setDoc(folderDocRef, {
                        ...window.folderStructure,
                        updatedAt: new Date()
                    }, { merge: true });
                } catch (error) {
                    console.error("Folder Sync Error:", error);
                }
            }
        };

        // Fix hamburger menu issue - Simplified approach
        document.addEventListener('click', function(e) {
            // Hamburger menu toggle for teacher
            if (e.target.closest('.hamburger-btn') && e.target.closest('#teacher-header')) {
                const menu = document.getElementById('hamburger-menu');
                if (menu) {
                    menu.classList.toggle('show');
                    e.stopPropagation();
                    return;
                }
            }
            
            // Close hamburger menu when clicking outside
            if (!e.target.closest('.hamburger-menu')) {
                document.getElementById('hamburger-menu').classList.remove('show');
            }
        });

        // Initialize App
        window.addEventListener('load', () => {
            if (localStorage.getItem('teacher_sess')) {
                Auth.reloadTeacherSession();
            }
        });
    </script>
</body>
</html>
